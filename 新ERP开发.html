<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>

<link rel="Stylesheet" type="text/css" href="style.css">
<link rel="Stylesheet" type="text/css" href="styles/style.css">
<link rel="Stylesheet" type="text/css" href="styles/style4Toc.css">
<link rel="stylesheet" type="text/css" href="styles/codeStyles/shCore.css">
<link rel="stylesheet" type="text/css" href="styles/codeStyles/shThemeDefault.css">

<title>新ERP开发</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script>
</head>
<body>

<div class="toc">
<ul>
<li class="menu1"><a href="#toc_1">问题 </a>
<li class="menu1"><a href="#toc_2">前端 </a>
<ul>
<li class="menu2"><a href="#toc_2.1">wzui项目 </a>
<li class="menu2"><a href="#toc_2.2">超时 </a>
</ul>
<li class="menu1"><a href="#toc_3">后端 </a>
<ul>
<li class="menu2"><a href="#toc_3.1">权限管理 </a>
<ul>
<li class="menu3"><a href="#toc_3.1.1">数据权限 </a>
<li class="menu3"><a href="#toc_3.1.2">字段权限 </a>
<li class="menu3"><a href="#toc_3.1.3">问题 </a>
</ul>
<li class="menu2"><a href="#toc_3.2">企业 </a>
<ul>
<li class="menu4"><a href="#toc_3.2.0.1">企业邀请 </a>
</ul>
</ul>
<li class="menu2"><a href="#toc_3.3">接口 </a>
</ul>
<li class="menu1"><a href="#toc_4">自动发送邮件配置 </a>
<li class="menu1"><a href="#toc_5">服务器 </a>
<li class="menu1"><a href="#toc_6">文件管理 </a>
<li class="menu1"><a href="#toc_7">数据库 </a>
<ul>
<li class="menu2"><a href="#toc_7.1">表 </a>
<ul>
<li class="menu3"><a href="#toc_7.1.1">获取租户ID </a>
</ul>
</ul>
<li class="menu1"><a href="#toc_8">问题 </a>
<ul>
<li class="menu2"><a href="#toc_8.1">swag </a>
<ul>
<li class="menu3"><a href="#toc_8.1.1">无法找到api </a>
</ul>
</ul>
</ul>
</div>
<div class="content">
<p>
查询可以按key， value查询<br />
搜接口  cloumnConfig/page<br />
</p>

<h1 id="toc_1">问题 </h1><HR SIZE=1>
<p>
获取访问的ip<br />
</p>

<h1 id="toc_2">前端 </h1><HR SIZE=1>
<ol>
<li>
打开终端，npm i 安装

<li>
cd 切换到packages\wz-translate下面 npm i，如果报错删除node_modules。然后重新npm i

<li>
复制一个.env.development 名字为.env.lw.local。更改代理地址

<li>
npx vue-cli-service serve --mode lw

</ol>


<p>
启动：<br />
</p>
<ol>
<li>
cd packages

<li>
cd wz-translate

<li>
npx vue-cli-service serve --mode lw

</ol>

<p>
发布<br />
</p>
<ol>
<li>
cnpm run build

<li>
生成文件夹disk。复制到c:\inetpub；

<li>
在IIS添加

</ol>


<h2 id="toc_2.1">wzui项目 </h2>
<p>
cd wzui/<br />
npm i<br />
npm run lib<br />
</p>


<h2 id="toc_2.2">超时 </h2>
<p>
E:\wz-erp-web-pro\wz-erp-web-pro\packages\wz-lib\lib\request<br />
</p>



<h1 id="toc_3">后端 </h1><HR SIZE=1>
<ol>
<li>
建模，数据库字段的确认

<li>
运行(创建数据库)，检查主启动类的注解@MapperScan(basePackages = "com.wzkj.warehouse.mapper"),和application.yml的名字

<li>
更改generator的配置，包括路径，数据库等。

<li>
运行com.wzkj.warehouse.common.generator.GeneratorUtil,生成model，Service等。

<li>
写业务逻辑

</ol>

<p>
判断为null等<br />
E:\wzkj\wzkj_hr\src\main\java\com\wzkj\hr\dto\request<br />
</p>

<p>
建议增删除改查等基础接口按照下面，或者大家定义的名称来写，<br />
前端对接会比较方便，减少不必要的沟通成本：<br />
</p>
<ol>
<li>
/add   增加 |  method post

<li>
/batch-add   批量增加 | method post

<li>
/remove   删除 | method delete

<li>
/batch-remove   批量删除 | method delete

<li>
/update   修改 | method put

<li>
/batch-update   批量修改 | method put

<li>
/list   分页查询 | method get

<li>
/init   初始化基础数据，如获取某下拉项目数据 | method get

<li>
/export   导出数据 | method get

<li>
/import   导入数据 | method put

<li>
/template-download    导入数据时候的模板下载 | method get

<li>
/remove/{id} 

<li>
/remove/{id}  | /batch-remove/{ids}  ps:ids为逗号隔开的id ;  

<li>
/detail/{id}  详情

<li>


</ol>


<p>
<a href="新ERP权限管理.html">新ERP权限管理</a>
</p>

<h2 id="toc_3.1">权限管理 </h2>
<p>
类JWTInfo：sourceSide 发起请求的应用端：比如系统后台管理，租户端，业务端<br />
</p>

<p>
getUserList<br />
</p>


<p>
toDataPrivilegeTypeEnum<br />
1 自己<br />
2 部门领导<br />
3 部门成员<br />
</p>


<p>
MybatisPlusInterceptor<br />
</p>
	
<p>
MybatisPlusConfig<br />
</p>

<p>
base_data_privilege 按钮、资源或接口<br />
base_resource_authority 权限表，字段authority_id对应的是角色base_group 的id。<br />
</p>

<p>
base_data_privilege 的element_id 对应base_element的id<br />
</p>



<ol>
<li>
添加资源base_element

<li>
base_data_privilege 添加权限类型，谁可以操作 element_id，在资源管理，对应接口

<li>
base_resource_authority 添加一个resource_type为column类型的，resource_id

<li>
base_resource_authority 的resource_id 对应base_data_privilege的id 对应base_data_privilege的id

</ol>

<h3 id="toc_3.1.1">数据权限 </h3>
<p>
com.wzkj.base.common.Handler.MyDataPermissionHandler<br />
</p>


<p>
表<br />
base_data_privilege<br />
</p>

<pre &lt;pre  name="code" class="brush: sql"&gt;>
SELECT DISTINCT u.id ,bp.id , bp.type, bg.id as groupId
 -- 数据权限，谁可以操作，自己？领导？同组人
 FROM base_data_privilege bp
 -- 元素表，按钮或资源等，就是接口
 LEFT JOIN base_element be
 ON be.id= bp.element_id
 -- 对按钮或资源，接口授权。上面的是数据权限，这里是接口权限
 LEFT JOIN base_resource_authority ba
 ON ba.resource_id = bp.id and ba.resource_type='data'
 LEFT JOIN base_group bg
 ON bg.id = ba.authority_id and ba.authority_type='group'
 LEFT JOIN base_group_member gm
 ON gm.group_id = bg.id
 LEFT JOIN base_user u
 ON gm.user_id = u.id
 WHERE u.STATUS = 1 AND be.uri = '/engineeringParam/queryList' AND bg.tenant_id = 1 AND u.id = 1
 UNION SELECT DISTINCT u.id, bp.id , bp.type, bg.id as groupId
 FROM base_data_privilege bp
 LEFT JOIN base_element be
 ON be.id= bp.element_id
 LEFT JOIN base_resource_authority ba
 ON ba.resource_id = bp.id and ba.resource_type='data'
 LEFT JOIN base_group bg
 ON bg.id = ba.authority_id and ba.authority_type='group'
 LEFT JOIN base_group_leader gm
 ON gm.group_id = bg.id
 LEFT JOIN base_user u
 ON gm.user_id = u.id
  WHERE u.STATUS = 1  AND be.uri = '/engineeringParam/queryList' AND bg.tenant_id = 1 AND u.id = 1;
</pre>

<h3 id="toc_3.1.2">字段权限 </h3>
<p>
com.wzkj.base.common.Handler.TimmingHandlerInterceptor<br />
</p>



<p>
构选后 base_cloumn_privilege 增加一行<br />
</p>


<p>
添加菜单：menu  <br />
</p>

<h3 id="toc_3.1.3">问题 </h3>
<ol>
<li>
你有权限，我也有权限，但看的行数是不一样的。

<li>
你有权限，我有权限，行数一样，但是某列敏感数据显示的不一样。

</ol>

<h2 id="toc_3.2">企业 </h2>
<p>
/rpc/registerInvitation 同步租户信息<br />
/registerTenantAdmin 注册企业及管理员<br />
</p>


<p>
<a href="http://localhost:8684/api/user/captcha/registerAdmin_84st6YTA">http://localhost:8684/api/user/captcha/registerAdmin_84st6YTA</a>  获取验证码
</p>

<h4 id="toc_3.2.0.1">企业邀请 </h4>
<p>
取消邀请状态：<br />
</p>
<ol>
<li>
register_invitation 的invitation_status设置为0

<li>
enterprise_tenant 删除记录

<li>


</ol>
<p>
base_tenant<br />
</p>

<p>
base_user<br />
</p>

<p>
enterprise_tenant<br />
</p>
<ol>
<li>


</ol>

<p>
邮箱已存在<br />
在cloud_admin_v2库里面不能存在相同邮箱<br />
</p>

<h2 id="toc_3.3">接口 </h2>
<p>
/enterpriseUser/saveOrUpdate 保存和更新用户<br />
</p>


<p>
public FrontUserV2 getUserInfoV2() { 登录是获取用户信息<br />
</p>


<p>
://localhost:8683/api/admin/api/user/captcha/68f4bd22-5dab-4066-bb71-8dbfc2e05e34<br />
</p>

<p>
/api/admin/api<br />
</p>

<p>
/test2/api/user/jwt/  getToken<br />
/api/admin/jwt/ getToken<br />
/user/captcha/{requestCode} 修改密码获取验证码<br />
</p>


<h1 id="toc_4">自动发送邮件配置 </h1><HR SIZE=1>
<p>
wzkj-message : resources application-dev.yml<br />
</p>


<h1 id="toc_5">服务器 </h1><HR SIZE=1>
<p>
Jenkins <br />
</p>

<p>
nohup java -jar wzkj-gateway-1.0.0-SNAPSHOT.jar &gt;./gateway_nohup.log 2&gt;&amp;1&amp;<br />
nohup java -jar wzkj-admin-1.0.0-SNAPSHOT.jar &gt;./admin_nohup.log 2&gt;&amp;1&amp;<br />
</p>

<p>
sudo docker run -d --privileged --restart=unless-stopped --net=host -v /etc/kubernetes:/etc/kubernetes -v /var/run:/var/run  rancher/rancher-agent:v2.5.7 --server <a href="https://10.10.7.10">https://10.10.7.10</a> --token ngzpcrbtv7b9rvn6cgwsdsmqwpqcgvwgz9g9pv5nsmx5mx4kbhnvmm --ca-checksum 912c3d31c22fd698a68ecaa39d3f9a643c1d8f5df6fe82d52f2537fdda19bd60 --worker
</p>

<p>
export NFSPATH =/nfs<br />
</p>

<p>
yum install -y nfs-common nfs-utils &amp;&amp; yum install -y<br />
</p>

<p>
docker images<br />
docker ps<br />
sudo docker run -d -p 9000:9000 --restart=always -v /var/run/docker.sock:/var/run/docker.sock --name portainer portainer/portainer<br />
docker stop \((docker ps -q) &amp;&amp; docker rm -f \)(docker ps -aq)<br />
</p>

<p>
docker ps -a<br />
docker run -d --restart=always --name=sentinel -p 8858:8858 -p 8719:8719 bladex/sentinel-dashboard:latest<br />
docker run -d --restart=always --name=zipkin   -p 9410:9410 -p 9411:9411 openzipkin/zipkin:latest<br />
docker run -d --restart=always --name=nacos    -p 8848:8848 --env MODE=standalone  nacos/nacos-server:1.4.1<br />
sudo docker run -d --privileged --restart=unless-stopped --net=host -v /etc/kubernetes:/etc/kubernetes -v /var/run:/var/run  rancher/rancher-agent:v2.5.7 --server <a href="https://10.10.7.10">https://10.10.7.10</a> --token s42wnwwf4r58tphhsshkkfvc667jkg7z7c8mbbm8fvgr7r47gqbbg8 --ca-checksum 912c3d31c22fd698a68ecaa39d3f9a643c1d8f5df6fe82d52f2537fdda19bd60 --etcd --controlplane --worker
export NGINX_HOME_PROXY=/data/nginx-web<br />
mkdir -p $NGINX_HOME_WEB/{conf,html,logs}<br />
</p>


<p>
find -name nginx/nginx.conf<br />
netstat -tanlp |grep 8080<br />
</p>

<h1 id="toc_6">文件管理 </h1><HR SIZE=1>
<p>
attachmentName 如果有传，则按这个名字作为名字<br />
</p>


<h1 id="toc_7">数据库 </h1><HR SIZE=1>
<h2 id="toc_7.1">表 </h2>
<h3 id="toc_7.1.1">获取租户ID </h3>
<p>
cloud_admin_v2 ：system_param_config<br />
</p>



<h1 id="toc_8">问题 </h1><HR SIZE=1>
<h2 id="toc_8.1">swag </h2>
<h3 id="toc_8.1.1">无法找到api </h3>
<p>
检查application.yml的swagger配置，base-package的值是不是当前项目的值。<br />
</p>


<div class="foot">
<button id="back_to_topA" class="back_to_top" style='background-color:red'>返回顶部</button>

<a id="returnIndexA" href="d:\vim\vim\mysite\note_html\笔记整理.html" onclick="fun_a()">
<button id=returnIndex class="back_to_index">返回首页</button>
</a>



<HR SIZE=5>
<p class="left">
<!-- <div class="text" style=" text-align:center;font-size:15px"></div>-->
© <span id="year">2018</span> 
</p>
<script src="scripts/my.js"></script>
<script src="scripts/script4Toc.js"></script>
<script type="text/javascript" src="scripts/codeStyleScript/XRegExp.js"></script>
<script type="text/javascript" src="scripts/codeStyleScript/shCore.js"></script>
<script type="text/javascript" src="scripts/codeStyleScript/shBrushJava.js"></script>
<script type="text/javascript" src="scripts/codeStyleScript/shBrushJScript.js"></script>
<script type="text/javascript" src="scripts/codeStyleScript/shBrushSql.js"></script>
<script type="text/javascript" src="scripts/codeStyleScript/shBrushCSharp.js"></script>
<script type="text/javascript" src="scripts/codeStyleScript/shBrushCss.js"></script>
<script type="text/javascript" src="scripts/codeStyleScript/shBrushPerl.js"></script>
<script type="text/javascript">
	SyntaxHighlighter.all()
</script>
</div>
</div>
</body>
</html>
