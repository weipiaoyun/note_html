<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<link rel="Stylesheet" type="text/css" href="style.css">
<title>tmp</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script>
</head>
<body>

<p>
using System;
using System.Collections.Generic;
using System.ComponentModel;
using System.Data;
using System.Drawing;
using System.Text;
using System.Linq;
using System.Reflection;
using System.Runtime.CompilerServices;
using System.Windows.Forms;
using DevExpress.XtraBars;
using DevExpress.XtraEditors.Filtering;
using DevExpress.XtraTreeList;
using DevExpress.XtraTreeList.Nodes;
</p>

<p>
using Ctl;
using Ctl.Pub;
using EngSys.CtlSql.Pub;
using EngSys.Unit.Pub;
using MOD.Sys;
using CTL.Pub;
</p>

<p>
namespace UI.Sys
{
</p>
<blockquote>
public partial class Frm_PrivSys : DevExpress.XtraBars.Ribbon.RibbonForm
{
public static MODEL_Frm_Config WinModel;
private Dictionary&lt;string, object&gt; dicControls = new Dictionary&lt;string, object&gt;();
private SqlRibbonPageControl pageEdit;
private SqlRibbonPageGroupControl groupEdit;
private LblTextBox lblUserNo;
private LblTextBox lblRealName;
private LblTextBox lblEmail;
private LblTextBox lblPasswd;
private SqlLblCombox cboArea;
private SqlLblCombox cboDepartment;
private SqlLblCombox cboGroup;
private SqlLblCombox cboTeam;
private SqlLblCombox cboPost;
private SqlLblCombox cboStatus;
private LblCheckBox chkIsMake;
private LblCheckBox chkIsCheck;
private LblTextBox lblTargetAbility_;
private LblTextBox lblGenUsr;
</blockquote>
<blockquote>
private DataTable dtDepartment;
private BarButtonItemControl btnAdd;
private BarButtonItemControl btnDel;
private BarButtonItemControl btnEdit;
private BarButtonItemControl btnExit;
private BarButtonItemControl btnSave;
private BarButtonItemControl btnUndo;
public Frm_PrivSys()
{
InitializeComponent();
this.Load += new EventHandler(Frm_PrivSys_Load);
}
</blockquote>
<blockquote>
private void Frm_PrivSys_Load(object sender, EventArgs e)
{
WinModel = this.Tag as MODEL_Frm_Config;
</blockquote>
<blockquote>
InitForm();
}
</blockquote>
<blockquote>
#region 初始化
private void InitForm()
{
//try
//{
sqlAutoPanel1.AutoLoad();
dicControls = sqlAutoPanel1.DicControl;
</blockquote>
<blockquote>
lblUserNo = dicControls["lblUserNo"] as LblTextBox;
lblRealName = dicControls["lblRealName"] as LblTextBox;
lblEmail = dicControls["lblEmail"] as LblTextBox;
lblPasswd = dicControls["lblPasswd"] as LblTextBox;
</blockquote>
<blockquote>
cboArea = dicControls["cboArea"] as SqlLblCombox;
cboDepartment = dicControls["cboDepartment"] as SqlLblCombox;
cboGroup = dicControls["cboGroup"] as SqlLblCombox;
cboTeam = dicControls["cboTeam"] as SqlLblCombox;
cboPost = dicControls["cboPost"] as SqlLblCombox;
cboStatus = dicControls["cboStatus"] as SqlLblCombox;
</blockquote>
<blockquote>
chkIsMake = dicControls["chkIsMake"] as LblCheckBox;
chkIsCheck = dicControls["chkIsCheck"] as LblCheckBox;
lblTargetAbility_ = dicControls["lblTargetAbility_"] as LblTextBox;
lblGenUsr = dicControls["lblGenUsr"] as LblTextBox;
</blockquote>
<blockquote>
cboArea.cboTextChanged += new SqlLblCombox.TextChangedEvent(cboArea_Change);
cboDepartment.cboTextChanged += new SqlLblCombox.TextChangedEvent(cboDepartment_Change);
cboGroup.cboTextChanged += new SqlLblCombox.TextChangedEvent(cboGroup_Change);
dtDepartment = new BLL.Sys.Get.BLL_Frm_PrivSys().GetUserListDepartment();
sqlAutoPanel1.IsLock_ = false;
</blockquote>
<blockquote>
this.DGV_UserList.View_.FocusedRowChanged += UserList_FocusedRowChanged;
this.tvwPriv.Properties.AfterCheckNode += tvwPriv_AfterCheckNode;
this.tvwDepartment.AutoLoad(dtDepartment);
this.tvwDepartment.treeClick += new SqlTreeview.MyEvent(tvwDepartment_Click);
</blockquote>
<blockquote>
//this.ribbon.Load();
//this.ribbon.btnClick += new SqlRibbonControl.BtnClick(ribbon_btnClick);
</blockquote>
<blockquote>
//Dictionary&lt;string, object&gt; dicGroupEdit = this.ribbon.Control_;
</blockquote>
<blockquote>
//pageEdit = this.ribbon.Control_["pageEdit"] as SqlRibbonPageControl;
groupEdit = this.pageEdit.Control_["groupEdit"] as SqlRibbonPageGroupControl;
if (groupEdit.Control_.ContainsKey("btnAdd"))
btnAdd = groupEdit.Control_["btnAdd"] as BarButtonItemControl;
if (groupEdit.Control_.ContainsKey("btnDel"))
btnDel = groupEdit.Control_["btnDel"] as BarButtonItemControl;
if (groupEdit.Control_.ContainsKey("btnEdit"))
btnEdit = groupEdit.Control_["btnEdit"] as BarButtonItemControl;
if (groupEdit.Control_.ContainsKey("btnExit"))
btnExit = groupEdit.Control_["btnExit"] as BarButtonItemControl;
if (groupEdit.Control_.ContainsKey("btnSave"))
btnSave = groupEdit.Control_["btnSave"] as BarButtonItemControl;
if (groupEdit.Control_.ContainsKey("btnUndo"))
btnUndo = groupEdit.Control_["btnUndo"] as BarButtonItemControl;
btnSave.Enabled = false;
btnUndo.Enabled = false;
</blockquote>
<blockquote>
//}
//catch (Exception ex)
//{
//    MessageBox.Show(ex.ToString());
//}
</blockquote>
<blockquote>
}
#endregion
</blockquote>
<blockquote>
#region priv
private void InitPrivList()
{
DataTable dtPrivRoot = new BLL.Sys.Get.BLL_Frm_PrivSys().GetT_sys_FrmMsP(lblUserNo.textBoxText);
if (dtPrivRoot.Rows.Count &gt; 0)
{
this.tvwPriv.Properties.BeginUnboundLoad();
</blockquote>
<blockquote>
foreach (DataRow dRow in dtPrivRoot.Rows)
{
TreeListNode node = this.tvwPriv.Properties.AppendNode(new object[] { dRow["ModuleName"].ToString() }, -1);
node.Tag = dRow;
</blockquote>
<blockquote>
AddChildPrivList(node);
}
this.tvwPriv.Properties.EndUnboundLoad();
}
}
</blockquote>
<blockquote>
private void AddChildPrivList(TreeListNode node)
{
DataRow drP = node.Tag as DataRow;
DataTable dt = new BLL.Sys.Get.BLL_Frm_PrivSys().GetT_sys_FrmMsC(Convert.ToInt32(drP["ModuleId"].ToString()), lblUserNo.textBoxText);
foreach (DataRow dRow in dt.Rows)
{
TreeListNode nodeC = this.tvwPriv.Properties.AppendNode(new object[] { dRow["FunctionName"].ToString() }, node);
if (lblUserNo.textBoxText.Equals(dRow["UserId"].ToString())) nodeC.Checked = true;
if (!this.btnSave.Enabled)
{
nodeC.Visible = nodeC.Checked ? true : false;
}
nodeC.Tag = dRow;
</blockquote>
<blockquote>
}
}
</blockquote>
<blockquote>
private List&lt;int&gt; GetUserPrivs()
{
List&lt;int&gt; priv = new List&lt;int&gt;();
</blockquote>
<blockquote>
string userNo = lblUserNo.textBoxText;
foreach (TreeListNode nodeRoot in this.tvwPriv.Properties.Nodes)
{
</blockquote>
<blockquote>
foreach (TreeListNode nodeChild in nodeRoot.Nodes)
{
if (nodeChild.Checked)
{
DataRow dr = nodeChild.Tag as DataRow;
priv.Add(Convert.ToInt32(dr["ModuleFuntionId"]));
}
}
}
return priv;
</blockquote>
<blockquote>
}
private void tvwPriv_AfterCheckNode(object sender, NodeEventArgs e)
{
if (e.Node.Checked)
{
e.Node.CheckAll();
}
else
{
e.Node.UncheckAll();
}
}
#endregion
</blockquote>
<blockquote>
#region DGV事件
private void UserList_FocusedRowChanged(object sender, DevExpress.XtraGrid.Views.Base.FocusedRowChangedEventArgs e)
{
DevExpress.XtraGrid.Views.Grid.GridView view = sender as DevExpress.XtraGrid.Views.Grid.GridView;
DataRow dr = view.GetFocusedDataRow();
if (dr == null) return;
lblUserNo.textBoxText = dr["用户名"].ToString();
lblRealName.textBoxText = dr["真名"].ToString();
lblEmail.textBoxText = dr["邮箱"].ToString();
lblPasswd.textBoxText = string.Empty;
cboArea.Properties.Text = dr["区域"].ToString();
cboDepartment.Properties.Text = dr["部门"].ToString();
cboGroup.Properties.Text = dr["组"].ToString();
cboTeam.Properties.Text = dr["小组"].ToString();
cboPost.Properties.Text = dr["职务"].ToString();
cboStatus.Properties.Text = dr["状态"].ToString();
</blockquote>
<blockquote>
DataRow drDetail = new BLL.Sys.Get.BLL_Frm_PrivSys().GetUserInfoDetail(Convert.ToInt32(lblUserNo.textBoxText));
if (drDetail != null)
{
chkIsMake.checked_ = Convert.ToBoolean(drDetail["IsMake"]);
chkIsCheck.checked_ = Convert.ToBoolean(drDetail["IsChk"]);
lblGenUsr.textBoxText = drDetail["GenUsr"].ToString();
lblTargetAbility_.textBoxText = drDetail["TargetAbility_"].ToString();
}
</blockquote>
<blockquote>
this.tvwPriv.Properties.Nodes.Clear();
InitPrivList();
}
#endregion
</blockquote>
<blockquote>
#region Ribbon事件
private void ribbon_btnClick(object sender, ItemClickEventArgs e)
{
DevExpress.XtraBars.BarButtonItem btn = e.Link.Item as DevExpress.XtraBars.BarButtonItem;
</blockquote>
<blockquote>
try
{
Type t = this.GetType();
MethodInfo _Info = t.GetMethod(btn.Name + "_Click");
object[] obj = new object[2] { sender, e };
_Info.Invoke(this, obj);
}
catch (Exception ex)
{
MessageBox.Show(ex.ToString());
}
</blockquote>
<blockquote>
}
</blockquote>
<blockquote>
public void btnAdd_Click(object sender, ItemClickEventArgs e)
{
</blockquote>
<blockquote>
this.sqlAutoPanel1.ClearValue();
this.sqlAutoPanel1.IsLock_ = true;
this.tvwPriv.Properties.OptionsView.ShowCheckBoxes = true;
</blockquote>
<blockquote>
btnSave.Enabled = true;
btnUndo.Enabled = true;
</blockquote>
<blockquote>
this.tvwPriv.Properties.Nodes.Clear();
InitPrivList();
}
</blockquote>
<blockquote>
public void btnEdit_Click(object sender, ItemClickEventArgs e)
{
if (string.IsNullOrEmpty(this.lblUserNo.textBoxText)) return;
this.sqlAutoPanel1.IsLock_ = true;
this.tvwPriv.Properties.OptionsView.ShowCheckBoxes = true;
btnSave.Enabled = true;
btnUndo.Enabled = true;
</blockquote>
<blockquote>
this.tvwPriv.Properties.Nodes.Clear();
InitPrivList();
}
</blockquote>
<blockquote>
public void btnUndo_Click(object sender, ItemClickEventArgs e)
{
this.sqlAutoPanel1.IsLock_ = false;
this.tvwPriv.Properties.OptionsView.ShowCheckBoxes = false;
btnSave.Enabled = false;
btnUndo.Enabled = false;
this.tvwPriv.Properties.Nodes.Clear();
InitPrivList();
}
public void btnSave_Click(object sender, ItemClickEventArgs e)
{
if (lblUserNo.textBoxText.Length == 0) return;
string strErr = new BLL.Sys.Get.BLL_Frm_PrivSys().SaveUserPar(this.sqlAutoPanel1.DicValue);
List&lt;int&gt; priv = GetUserPrivs();
new BLL.Sys.Get.BLL_Frm_PrivSys().SaveUserPriv(Convert.ToInt32(lblUserNo.textBoxText), priv);
this.sqlAutoPanel1.IsLock_ = false;
this.tvwPriv.Properties.OptionsView.ShowCheckBoxes = false;
btnSave.Enabled = false;
btnUndo.Enabled = false;
this.tvwPriv.Properties.Nodes.Clear();
InitPrivList();
}
</blockquote>
<blockquote>
public void btnDel_Click(object sender, ItemClickEventArgs e)
{
DataRow dr = this.DGV_UserList.View_.GetFocusedDataRow();
if (dr == null || dr.IsNull("用户名")) return;
new BLL.Sys.Get.BLL_Frm_PrivSys().DeleteUser(dr["用户名"].ToString());
this.tvwPriv.Properties.Nodes.Clear();
InitPrivList();
tvwDepartment_Click(this.tvwDepartment, null);
}
</blockquote>
<blockquote>
public void btnExit_Click(object sender, ItemClickEventArgs e)
{
this.Close();
}
</blockquote>
<blockquote>
#endregion
</blockquote>
<blockquote>
#region combobox事件
private void cboArea_Change(object sender, EventArgs e)
{
if (cboArea.Properties.EditValue.ToString().Equals("ListNo"))
{
this.cboDepartment.DataSource(null);
return;
}
</blockquote>
<blockquote>
int areaId = Convert.ToInt32(cboArea.Properties.EditValue);
DataRow[] dr = dtDepartment.Select(String.Format("Type_ = 'Department' AND Pid_ = {0}", areaId));
DataTable dt = new DataTable();
dt.Columns.Add("ListNo");
dt.Columns.Add("ListName");
</blockquote>
<blockquote>
foreach (DataRow row in dr)
{
dt.Rows.Add(row["Id_"], row["Captions_"]);
}
this.cboDepartment.DataSource(dt);
}
</blockquote>
<blockquote>
private void cboDepartment_Change(object sender, EventArgs e)
{
if (cboDepartment.Properties.EditValue.ToString().Equals("ListNo"))
{
this.cboGroup.DataSource(null);
return;
}
</blockquote>
<blockquote>
int departmentId = Convert.ToInt32(cboDepartment.Properties.EditValue);
</blockquote>
<blockquote>
DataRow[] dr = dtDepartment.Select(String.Format("Type_ = 'Group' AND Pid_ = {0}", departmentId));
DataTable dt = new DataTable();
dt.Columns.Add("ListNo");
dt.Columns.Add("ListName");
</blockquote>
<blockquote>
foreach (DataRow row in dr)
{
dt.Rows.Add(row["Id_"], row["Captions_"]);
}
this.cboGroup.DataSource(dt);
}
</blockquote>
<blockquote>
private void cboGroup_Change(object sender, EventArgs e)
{
if (cboGroup.Properties.EditValue.ToString().Equals("ListNo"))
{
this.cboTeam.DataSource(null);
return;
}
</blockquote>
<blockquote>
int groupId = Convert.ToInt32(cboGroup.Properties.EditValue);
</blockquote>
<blockquote>
DataRow[] dr = dtDepartment.Select(String.Format("Type_ = 'Team' AND Pid_ = {0}", groupId));
DataTable dt = new DataTable();
dt.Columns.Add("ListNo");
dt.Columns.Add("ListName");
</blockquote>
<blockquote>
foreach (DataRow row in dr)
{
dt.Rows.Add(row["Id_"], row["Captions_"]);
}
this.cboTeam.DataSource(dt);
//sqlAutoPanel1.SaveTypeId();
Dictionary&lt;string, object&gt; dicValue = sqlAutoPanel1.DicValue;
}
#endregion
</blockquote>
<blockquote>
private void tvwDepartment_Click(object sender, EventArgs e)
{
SqlTreeview tree = sender as SqlTreeview;
DevExpress.XtraTreeList.Nodes.TreeListNode node = tree.FocusedNode;
DataRow drNode = node.Tag as DataRow;
DataTable dtUser = new BLL.Sys.Get.BLL_Frm_PrivSys().GetUserList(drNode);
this.DGV_UserList.Grid_.DataSource = dtUser;
</blockquote>
<blockquote>
}
</blockquote>
<blockquote>
private void TxtInvoke(DataRow dr, string ctlNames)
{
//Type t = this.GetType();//获得该类的Type
//FieldInfo v = t.GetField(ctlNames);
// var a = v.GetValue(null);
//Console.WriteLine(v.Name);Console.WriteLine(v.FieldType.Name);
////DevExpress.XtraEditors.PanelControl a = (DevExpress.XtraEditors.PanelControl)v;
</blockquote>
<blockquote>
//Console.WriteLine(v.ToString());
//Type tGroup = v.GetType();
//Console.WriteLine(tGroup.ToString());
//Console.WriteLine(value);
//foreach (var v in t.GetFields())
//{
//    Console.WriteLine("---------------------");
//    Console.WriteLine(v.Name);
//    Console.WriteLine("---------------------");}
</blockquote>
<blockquote>
////再用Type.GetProperties获得PropertyInfo[],然后就可以用foreach 遍历了
//foreach (PropertyInfo pi in t.GetProperties())
//{
//    object value1 = pi.GetValue(this, null);//用pi.GetValue获得值
//    string name = pi.Name;//获得属性的名字,后面就可以根据名字判断来进行些自己想要的操作
//    if (name.Equals("Ctl_UserPar") || name.Equals("ucTextBox1"))
//    {
</blockquote>
<blockquote>
//        MessageBox.Show("11");
//    }
</blockquote>
<blockquote>
//}
</blockquote>
<blockquote>
LblTextBox txt = new LblTextBox();
</blockquote>
<blockquote>
}
</blockquote>
<blockquote>
private void ribbon_Click(object sender, EventArgs e)
{
</blockquote>
<blockquote>
}
</blockquote>
<blockquote>
private void Frm_PrivSys_Load_1(object sender, EventArgs e)
{
</blockquote>
<blockquote>
}
</blockquote>
<blockquote>
private void sqlAutoPanel1_Load(object sender, EventArgs e)
{
</blockquote>
<blockquote>
}
</blockquote>
<blockquote>
private void tvwPriv_Load(object sender, EventArgs e)
{
</blockquote>
<blockquote>
}
</blockquote>
<blockquote>
private void ribbon_Click_1(object sender, EventArgs e)
{
</blockquote>
<blockquote>
}
</blockquote>
<blockquote>
}
</blockquote>
<p>
}
</p>

<button class="back_to_top">返回顶部</button>
<script src="my.js"></script>
<HR SIZE=5>
<p class="left">
<!-- <div class="text" style=" text-align:center;font-size:15px"></div>-->
© <span id="year">2018</span> 惟飘云-不忘初心!砥砺前行
</p>
</body>
</body>
</html>
