<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>

<link rel="Stylesheet" type="text/css" href="style.css">
<link rel="Stylesheet" type="text/css" href="styles/style.css">
<link rel="Stylesheet" type="text/css" href="styles/style4Toc.css">
<link rel="stylesheet" type="text/css" href="styles/codeStyles/shCore.css">
<link rel="stylesheet" type="text/css" href="styles/codeStyles/shThemeDefault.css">

<title>ERP过数</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script>
</head>
<body>







<ol>
<li>
品质管控

<li>
绑定工厂

<li>
set尺寸在公差在1mm之内要提醒

<li>
这个客户型号在当前工序有被投诉过。提示被投诉内容。

<li>
步骤号和名字是否一样

<li>
正常，外发，反工生产。

<li>
如果反工，有返工流程。

<li>
班组内过数。 部门，工序，流程。

<li>
插入48表。过数表。

<li>
更新56表，工序和步骤号等更新。反工的最后一个工序。

<li>
返工最后一个工序，把工序更新为正常？

<li>


</ol>











































<p>
unit WO_Count;<br />
</p>

<p>
interface<br />
</p>

<p>
uses<br />
  Windows, Messages, SysUtils, Variants, Classes, Graphics, Controls, Forms,<br />
  Dialogs, ExtCtrls, Menus, StdCtrls, Mask, DBCtrls, Buttons, Grids,math,StrUtils,<br />
  DBGrids,AdoDB, ppComm, ppRelatv, ppProd, ppClass, ppReport, DBGridEh, DB,IdHTTP,<br />
  ComCtrls;<br />
</p>

<p>
type<br />
  TfrmWO_Count = class(TForm)<br />
</p>
<blockquote>
Panel1: TPanel;
Label15: TLabel;
Label5: TLabel;
Label6: TLabel;
Label7: TLabel;
Label12: TLabel;
DBEdit1: TDBEdit;
DBEdit2: TDBEdit;
DBEdit3: TDBEdit;
DBEdit4: TDBEdit;
DBEdit5: TDBEdit;
Panel2: TPanel;
SpeedButton2: TSpeedButton;
Label14: TLabel;
Label8: TLabel;
DBEdit9: TDBEdit;
DBEdit10: TDBEdit;
Label4: TLabel;
DBEdit11: TDBEdit;
Label1: TLabel;
DBEdit6: TDBEdit;
Label2: TLabel;
Label3: TLabel;
EdtPNL: TDBEdit;
EdtPcs: TDBEdit;
rgType: TRadioGroup;
btnOk: TBitBtn;
Label11: TLabel;
DBEdit12: TDBEdit;
Label13: TLabel;
DBEdit13: TDBEdit;
Label16: TLabel;
ComboBox1: TComboBox;
GroupBox2: TGroupBox;
edtNewPCS: TEdit;
Label17: TLabel;
edtNewPNL: TEdit;
CheckBox3: TCheckBox;
edtDiscardQty: TDBEdit;
Label19: TLabel;
CheckBox1: TCheckBox;
CheckBox2: TCheckBox;
Label10: TLabel;
Label18: TLabel;
ComboBox2: TComboBox;
Label20: TLabel;
ComboBox3: TComboBox;
Label21: TLabel;
Label22: TLabel;
lv1: TListView;
CheckBox4: TCheckBox;
Label9: TLabel;
ComboBox4: TComboBox;
procedure SpeedButton2Click(Sender: TObject);
procedure btnOkClick(Sender: TObject);
procedure SpeedButton4Click(Sender: TObject);
procedure SpeedButton5Click(Sender: TObject);
procedure edtNewPCSKeyPress(Sender: TObject; var Key: Char);
procedure edtNewPCSExit(Sender: TObject);
procedure edtNewPNLExit(Sender: TObject);
procedure lv1MouseDown(Sender: TObject; Button: TMouseButton;
Shift: TShiftState; X, Y: Integer);
procedure lv1SelectItem(Sender: TObject; Item: TListItem;
Selected: Boolean);
procedure lv1Exit(Sender: TObject);
procedure CheckBox4Click(Sender: TObject);
</blockquote>

<p>
  private<br />
</p>
<blockquote>
//FType:integer;
v_Pcs,v_PNL:integer;
PCS_PER_PNL:integer;
NextDept:Integer;   //ADD by zsp
r_type,clamp06:Integer;
sNWkNo:string;
function Update_Data(rkey06:integer):boolean;
function Update_Data_Son(rkey06:integer): boolean;//过数合拼料号的子工单
function Update_0048(From_Dept,Next_Dept,UserId,WType,PutType,Wo_ptr,StepNo,rkey25:Integer):boolean;
function Update_0048_2(From_Dept,Next_Dept,UserId,WType,PutType,Wo_ptr,StepNo:integer):boolean;
//function Update_0041(rkey06:integer):boolean; //更新员工工作量
function savAlid:boolean;
procedure Update_WIPMAT_STATUS(rKey06: Integer);
function CheckNearSize(rkey25,nextdept_ptr:Integer):Boolean;
function ShowComplaints(Rkey34:Integer;MANU_DESC:string):string;
</blockquote>
<p>
  public<br />
</p>
<blockquote>
FaFct:array of integer;
procedure enter(rKey_User:integer;WoNo:string);
function WoClamp(rkey06,clamp06:Integer):boolean;//合并作业单
function check_woclamp(rkey06,clamp06:Integer):boolean;//判断是否可以合卡
function INQCLocked(ARkey06,ARkey34,AQty: Integer): string;//是否在QC管控中
function INSPCLocked(ARkey06,ARkey34: Integer;var ErrStr: string): Boolean;//是否在SPC管控中
</blockquote>

<p>
  end;<br />
</p>

<p>
var<br />
  frmWO_Count: TfrmWO_Count;<br />
</p>

<p>
implementation<br />
uses dm,MyClass,common,Dlg_Wo_Qty,report_data;<br />
{$R *.dfm}<br />
</p>

<p>
procedure TfrmWO_Count.enter(rKey_User: integer;WoNo:string);<br />
var //c:char;<br />
</p>
<blockquote>
//s:string;
i,L:integer;
//b:boolean;
Item: TListItem;
</blockquote>
<p>
begin<br />
  with dmcon.aqTmp do<br />
  begin<br />
</p>
<blockquote>
Close;
SQL.Text := 'select data0034.DEPT_NAME,data0006.WORK_ORDER_NUMBER,data0203.return_code,data0260.seq_no '+
' from data0260  '+
' inner join data0203 on data0203.rkey=data0260.rkey203 '+
' inner join data0034 on data0034.RKEY=data0260.dept_ptr '+
' inner join data0252 on data0252.rkey203 = data0203.rkey  '+
' inner join data0006 on data0006.RKEY=data0252.rkey06 '+
' where  '+
' data0260.auth_flag=1 and  data0006.WORK_ORDER_NUMBER='''+ WoNo+'''' ;
Open;
if not IsEmpty then
begin
ShowMessage('当前作业单正在进行返工审核，还有未审核部门，返工代码为：'+FieldByName('return_code').AsString+'，当前需审核部门为：'+FieldByName('DEPT_NAME').AsString );
Exit;
end;
</blockquote>
<p>
  end;<br />
  with dmcon.aqTmp do<br />
  begin<br />
</p>
<blockquote>
Close;
SQL.Text := 'select data0238.rkey,data0203.return_code from data0203 inner join data0252 on data0203.rkey=data0252.rkey203 '+
' inner join data0006 on data0252.rkey06=data0006.RKEY ' +
' left join data0238 on data0006.RKEY=data0238.WO_PTR '+
' where data0203.status&lt;&gt;4 and data0238.rkey is null and WORK_ORDER_NUMBER='''+ WoNo+'''' ;
Open;
if (not IsEmpty)  then
begin
ShowMessage('当前作业单返工完成未经过品质确认，返工代码为：'+FieldByName('return_code').AsString+'品质部要求返工完成需要品质确认，请找品质人员进行处理');
Exit;
end;
</blockquote>
<p>
  end;<br />
  //2019-10-11更新 现在东莞hdi二厂返工各个工序需要确认才能过数<br />
  with dmcon.aqTmp do<br />
  begin<br />
</p>
<blockquote>
Close;
SQL.Text := 'select data0238.rkey,data0203.return_code,data0034.dept_name from data0203 inner join data0239_1 on data0203.rkey=data0239_1.rkey203 '+
' inner join data0006 on data0239_1.rkey06=data0006.RKEY ' +
' inner join data0056 on data0006.rkey=data0056.wo_ptr and data0239_1.dept_ptr=data0056.dept_ptr' +
' left join data0238 on data0239_1.rkey238=data0238.rkey '+
' inner join data0015 on data0015.rkey=data0006.WHOUSE_PTR '+
' inner join data0034 on data0034.rkey=data0239_1.dept_ptr'  +
' where isnull(data0239_1.QuatityConfirme,0)=0 and data0015.warehouse_code=''D0002''  and WORK_ORDER_NUMBER='''+ WoNo+'''' ;
Open;
if (not IsEmpty)  then
begin
ShowMessage('当前作业单当工序返工完成未经过品质确认，需确认部门为:'''+FieldByName('dept_name').AsString+''',返工代码为：'''+FieldByName('return_code').AsString+'''.品质部要求每个工序返工完成需要工序人员输入返工人员和线别，然后找品质进行工序返工确认，请到返工工序确认输入返工人员和线别以及进行品质确认');
Exit;
end;
</blockquote>
<p>
  end;<br />
</p>

<p>
  if not dmcon.Check_WO(WoNo) then  abort; //判断作业单是否处于生产中或者外发生产状态,否则不允许过数<br />
//  if not dmcon.Check_WO_Son(WoNo) then Abort;//判断作业单是否有子工单处于等待状态，有的话就不允许过数<br />
  MyDataClass.OpenDataSetByPara(WoNo,dmcon.adsWOInfo); //打开作业单<br />
  //对下一工序而言<br />
  if not dmcon.Check_User_Factory(rKey_User,dmcon.adsWOInfo.FieldByName('rkey06').AsInteger) then<br />
  begin<br />
</p>
<blockquote>
ShowMsg('过数人员所定义工厂与当前作业单的工厂不一致,不允许过数!',1);
abort;
</blockquote>
<p>
  end;<br />
</p>

<p>
 ///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////<br />
  with dmcon.ADOSpell_60 do //判断是不是合拼的子工单，并且母工单是否在线，如果是这种情况不不允许过数，直接过合拼料号母工单就可以了<br />
  begin<br />
</p>
<blockquote>
Close;
Parameters[0].Value:=wono;
Open;
</blockquote>
<p>
  end;<br />
  if (not dmcon.ADOSpell_60.IsEmpty) and (dmcon.ADOSpell_60.FieldByName('spellTogether').Value=1) then//是合拼的子单<br />
  begin<br />
</p>
<blockquote>
with dmcon.ADOSpell_06 do
begin
Close;
Parameters[0].Value:=dmcon.ADOSpell_60.fieldbyname('cust_part_ptr').Value;
Parameters[1].Value:=dmcon.ADOSpell_60.fieldbyname('rkey').Value;
Parameters[2].Value:=dmcon.adsWOInfoSUB_LEVELS.Value;
Parameters[3].Value:=dmcon.ADOSpell_60.fieldbyname('cut_no').AsString;
Open;
end;
if not dmcon.ADOSpell_06.IsEmpty then
begin
ShowMsg('当前作业单有合拼的母工单在线不能过数,请直接过合拼的母工单:'+dmcon.ADOSpell_06.fieldbyname('work_order_number').AsString,1);
exit;
end;  
</blockquote>
<p>
  end;<br />
///////////////////////////////////////////////////////////add by hcc///////////////////////////////////////////////////////////////<br />
  if not dmcon.Check_User_Auth(rKey_User,WoNo) then   //(只是对单有工序而言)判断过数人员是否有权限对当前作业单过数，<br />
  begin<br />
</p>
<blockquote>
ShowMsg('您没有当前工序的过数权限,请联系系统管理员!',1);
abort;
</blockquote>
<p>
  end;<br />
//  if dmcon.adsWOInfo.fieldByname('SETUP_TIME_PER_LOT').AsString&lt;&gt;'' then<br />
//    ComboBox3.Items.Append(dmcon.adsWOInfo.fieldByname('SETUP_TIME_PER_LOT').AsString);<br />
//  if dmcon.adsWOInfo.fieldByname('QUEUE_TIME').AsString&lt;&gt;'' then<br />
//    ComboBox3.Items.Append(dmcon.adsWOInfo.fieldByname('QUEUE_TIME').AsString);<br />
//  if dmcon.adsWOInfo.fieldByname('PROCESS_TIME').AsString&lt;&gt;'' then<br />
//    ComboBox3.Items.Append(dmcon.adsWOInfo.fieldByname('PROCESS_TIME').AsString);<br />
//  if dmcon.adsWOInfo.fieldByname('PROCESS_TIME_B').AsString&lt;&gt;'' then<br />
//    ComboBox3.Items.Append(dmcon.adsWOInfo.fieldByname('PROCESS_TIME_B').AsString);<br />
//  if ComboBox3.Items.Count&gt;0 then ComboBox3.ItemIndex:=-1;<br />
  with dmcon.ADOQuery1 do<br />
  begin<br />
</p>
<blockquote>
Close;
SQL.Clear;
SQL.Add('select * from data0238 where wo_ptr='+dmcon.adsWOInfo.FieldByName('rkey06').AsString);
Open;
</blockquote>
<p>
  end;<br />
  if (not dmcon.ADOQuery1.IsEmpty) and (dmcon.adsWOInfo.FieldByName('Wtype06').Value=3)and(dmcon.adsWOInfo.FieldByName('wtype').AsInteger&gt;0) then //作业单为返工状态且返工还没结束<br />
  begin //走返工流程238<br />
   rgType.ItemIndex:=1;<br />
   rgType.Enabled:=False;<br />
   dmcon.NextStep_238.Close;<br />
   dmcon.NextStep_238.Parameters.ParamByName('F01').Value :=dmcon.adsWOInfo.fieldByname('rkey06').Value;<br />
   dmcon.NextStep_238.Parameters.ParamByName('F02').Value :=dmcon.adsWOInfo.fieldByname('STEP').Value;<br />
   dmcon.NextStep_238.Open;<br />
   GroupBox2.Caption:='下工序 ：'+trim(dmcon.NextStep_238.fieldByName('DEPT_CODE').AsString)+'-'+trim(dmcon.NextStep_238.fieldByName('DEPT_NAME').AsString)+'-'+trim(dmcon.NextStep_238.fieldByName('STEP_NUMBER').AsString);<br />
</p>
<blockquote>
NextDept:= dmcon.NextStep_238.FieldByName('rkey').AsInteger;
</blockquote>
<p>
  end<br />
  else<br />
  begin //走正常流程38<br />
   with dmcon.ADOQuery1 do<br />
   begin<br />
</p>
<blockquote>
Close;
SQL.Clear;
sql.Add('select DEPT_PTR from data0038 where SOURCE_PTR='+dmcon.adsWOInfo.fieldByname('Bom_ptr').AsString);
sql.Add('and STEP_NUMBER='+dmcon.adsWOInfo.fieldByname('STEP').AsString);
Open;
</blockquote>
<p>
   end;<br />
   if dmcon.ADOQuery1.FieldByName('dept_ptr').Value&lt;&gt;dmcon.adsWOInfo.FieldByName('DEPT_PTR').Value then<br />
   begin<br />
</p>
<blockquote>
MessageDlg('当前工序步骤发生变化,产品流程有改动,不能过数!',mtInformation,[mbOK],1);
Exit;
</blockquote>
<p>
   end;<br />
   dmcon.aqNextStepNO.Close;<br />
   dmcon.aqNextStepNO.Parameters.ParamByName('F01').Value :=dmcon.adsWOInfo.fieldByname('Bom_ptr').Value;<br />
   dmcon.aqNextStepNO.Parameters.ParamByName('F02').Value :=dmcon.adsWOInfo.fieldByname('STEP').Value;<br />
   dmcon.aqNextStepNO.open;<br />
   GroupBox2.Caption:='下工序 ：'+trim(dmcon.aqNextStepNO.fieldByName('DEPT_CODE').AsString)+'-'+trim(dmcon.aqNextStepNO.fieldByName('DEPT_NAME').AsString)+'-'+trim(dmcon.aqNextStepNO.fieldByName('STEP_NUMBER').AsString);<br />
</p>
<blockquote>
NextDept:= dmcon.aqNextStepNO.FieldByName('rkey').AsInteger;
</blockquote>
<p>
  end;<br />
//显示<br />
  checkbox2.Checked:=not dmcon.adsWOInfo.fieldByName('ALLOW_SPLIT_LOTS').IsNull and<br />
</p>
<blockquote>
(dmcon.adsWOInfo.fieldByName('ALLOW_SPLIT_LOTS').AsString='Y');  //PNL清0
</blockquote>
<p>
 ////////////增加产线设备 add by hcc 2019-01-23<br />
 ///检测当前工厂及当前工序是否设置了重要生产选择<br />
 with dmcon.aqTmp do<br />
 begin<br />
  Close;<br />
  sql.Clear;<br />
  SQL.Add('select fasset_name from Y1417 ');<br />
  sql.Add('where warehouse_ptr='+dmcon.adsWOInfoLOC_PTR.AsString);<br />
  SQL.Add('and dept_ptr='+dmcon.adsWOInfoDEPT_PTR.AsString);<br />
  Open;<br />
 end;<br />
 if not dmcon.aqTmp.IsEmpty then<br />
 begin<br />
  dmcon.aqTmp.First;<br />
  while not dmcon.aqTmp.Eof do<br />
  begin<br />
   ComboBox3.Items.Add(dmcon.aqTmp.fieldbyname('fasset_name').AsString);<br />
   dmcon.aqTmp.Next;<br />
  end;<br />
 end;<br />
 ComboBox3.Text:=dmcon.adsWOInfoREFERENCE.AsString;<br />
 ///检测当前工厂及下个工序是否有重要产线<br />
 with dmcon.aqTmp2 do<br />
 begin<br />
  Close;<br />
  sql.Clear;<br />
  SQL.Add('select fasset_name from Y1417 ');<br />
  sql.Add('where warehouse_ptr='+dmcon.adsWOInfoLOC_PTR.AsString);<br />
  SQL.Add('and dept_ptr='+inttostr(NextDept));<br />
  Open;<br />
 end;<br />
 if not dmcon.aqTmp2.IsEmpty then<br />
 begin<br />
  dmcon.aqTmp2.First;<br />
  while not dmcon.aqTmp2.Eof do<br />
  begin<br />
   ComboBox4.Items.Add(dmcon.aqTmp2.fieldbyname('fasset_name').AsString);<br />
   dmcon.aqTmp2.Next;<br />
  end;<br />
 end;<br />
 //////////// end by hcc<br />
  if  not checkbox2.Checked then checkbox2.Enabled:=false;<br />
</p>

<p>
  v_Pcs:= dmcon.adsWOInfo.fieldByname('QTY_BACKLOG').Asinteger;<br />
  v_PNL:= dmcon.adsWOInfo.fieldByname('PANELS').Asinteger;<br />
  if (dmcon.adsWOInfo.FieldByName('prod_status').AsInteger = 4)  then //外发生产<br />
</p>
<blockquote>
rgType.ItemIndex :=2;
</blockquote>
<p>
  if (dmcon.adsWOInfo.FieldByName('TType').AsInteger=3) or (dmcon.adsWOInfo.FieldByName('WType').AsInteger &gt;0) then //MRB返修,那么属于返工状态<br />
</p>
<blockquote>
rgType.ItemIndex :=1;        //返工生产
</blockquote>

<p>
  dmcon.tmp.Close;<br />
  dmcon.tmp.SQL.Text:='select rkey,abbr_name from data0015 where active_flag='+quotedstr('Y')+' order by rkey';<br />
  dmcon.tmp.Open;<br />
  SetLength(fafct,dmcon.tmp.RecordCount);<br />
</p>

<p>
  for i:=0 to dmcon.tmp.RecordCount-1 do<br />
  begin<br />
</p>
<blockquote>
FaFct[i]:=dmcon.tmp.Fields[0].AsInteger;
ComboBox1.Items.Append(dmcon.tmp.Fields[1].asstring);
ComboBox2.Items.Append(dmcon.tmp.Fields[1].asstring);
dmcon.tmp.Next;
</blockquote>
<p>
  end;<br />
</p>

<p>
  dmcon.tmp.Close;<br />
  dmcon.tmp.SQL.Text:='select data0056.loc_ptr,data0015.abbr_name from data0056 inner join data0015'+<br />
  ' on data0056.loc_ptr=data0015.rkey'+<br />
  ' where data0056.Wo_ptr='+dmcon.adsWOInfo.FieldbyName('rKey06').Asstring;<br />
  dmcon.tmp.Open;<br />
</p>

<p>
  ComboBox1.ItemIndex:=ComboBox1.Items.IndexOf(dmcon.tmp.FieldByName('abbr_name').AsString);<br />
</p>

<p>
  if dmcon.adsUserInfo.FieldByName('warehouse_ptr').AsInteger &gt; 0 then<br />
  for i:=Low(fafct) to High(fafct) do    //如果过数人员定义了工厂<br />
   begin<br />
</p>
<blockquote>
if FaFct[i]=dmcon.adsUserInfo.FieldByName('warehouse_ptr').AsInteger then
ComboBox2.ItemIndex:=i  ;//下工序生产工厂
</blockquote>
<p>
   end<br />
  else<br />
  for i:=Low(fafct) to High(fafct) do<br />
   begin<br />
</p>
<blockquote>
//if FaFct[i]=dmcon.tmp.Fields[0].AsInteger then
//ComboBox1.ItemIndex:=i  ;//过数工厂
if FaFct[i]=dmcon.adsWOInfo.FieldbyName('whouse_ptr').AsInteger then
ComboBox2.ItemIndex:=i  ;//下工序投产工厂
</blockquote>
<p>
   end;<br />
  combobox1.Enabled:=false;<br />
  edtNewPCS.Text:=EdtPcs.Text;<br />
  edtNewPNL.Text:=EdtPNL.Text;<br />
</p>

<p>
//  s:=trim(DBEdit1.Text);<br />
//  c:=s[length(S)];<br />
//  if not (c in ['0'..'9']) then   //已经是拆分的子单不能拆分<br />
//    b:=false<br />
//  else<br />
//  begin<br />
//    dmcon.tmp.Close;<br />
//    dmcon.tmp.SQL.Text:='select 1  from data0034 where PERMIT_SPLIT_LOT=1 and rKey= '+dmcon.adsWOInfo.FieldByName('Dept_ptr').Asstring;<br />
//    dmcon.tmp.Open;<br />
//    b:=not dmcon.tmp.IsEmpty ;<br />
//    if b then<br />
//    begin<br />
//      dmcon.tmp.Close;<br />
//      dmcon.tmp.SQL.Text:='select work_order_number  from data0006 where work_order_number like '''+DBEdit1.Text+'%'' order by 1 desc' ;<br />
//      dmcon.tmp.Open;<br />
//      c:=dmcon.tmp.fields[0].asstring[length(dmcon.tmp.fields[0].asstring)];<br />
//      if c in ['0'..'9'] then<br />
//        sNWkNo:=s+'A'<br />
//      else if c in ['A','B','a','b'] then    //在此最多拆分3次<br />
//        sNWkNo:=s+Chr(Ord(c)+1)<br />
//      else<br />
//        b:=false;<br />
//    end ;<br />
//    b:=False;<br />
//  end;<br />
//  if not b then<br />
//  begin<br />
</p>
<blockquote>
edtNewPCS.Enabled:=false;
edtNewPNL.Enabled:=false;
CheckBox3.Enabled:=false;
edtNewPCS.Color:=clGray;
edtNewPNL.Color:=clGray;
</blockquote>
<p>
//  end ;<br />
  PCS_PER_PNL:=dmcon.adsWOInfo.fieldbyname('PARTS_PER_PANEL').AsInteger;<br />
  CheckBox1.Enabled:= dmcon.adsUserInfo.fieldByName('OutSource').AsBoolean;<br />
  checkbox1.Checked:=CheckBox1.Enabled;<br />
  r_type:=0;//正常过数(无合并需求)<br />
  if (dmcon.adsWOInfo.FieldByName('cutno_wo').Value='') or (dmcon.adsWOInfo.FieldByName('parent_ptr').Value&gt;0) then//合卡条件判断(内层工单，或外层工单无刻印内容)<br />
  begin<br />
   L:=Length(WoNo);<br />
   with dmcon.WoClampIn do<br />
   begin<br />
</p>
<blockquote>
Close;
if (dmcon.adsWOInfo.FieldByName('Wtype06').Value=3)and(dmcon.adsWOInfo.FieldByName('wtype').AsInteger&gt;0) then //作业单为返工状态且返工还没结束
begin
with dmcon.tmp do
begin
Close;
sql.Clear;
SQL.Add('select max(step_number) as mstep from data0238 ');
sql.Add('where data0238.wo_ptr='+dmcon.adsWOInfo.FieldbyName('rKey06').AsString);
Open;
end;
if dmcon.NextStep_238.FieldByName('step_number').Value=dmcon.tmp.FieldByName('mstep').Value then //返工为最后一个工序时，步骤会发生变化
Parameters[0].Value:=dmcon.adsWOInfo.FieldValues['wtype']
else
Parameters[0].Value:=dmcon.NextStep_238.FieldValues['step_number'];
end
else
begin
Parameters[0].Value:=dmcon.aqNextStepNO.FieldValues['step_number'];
end;
Open;
if (WoNo[L] in ['0'..'9']) then
begin
//dmcon.WoClampIn.SQL.Text:=dmcon.WoClampIn.SQL.Text+'and data0006.work_order_number'+' like ''%'+LeftStr(WoNo, L)+'%''';
dmcon.WoClampIn.Filter:='work_order_number'+' like ''%'+LeftStr(WoNo, L)+'%''';
end
else
begin
dmcon.WoClampIn.Filter:='work_order_number'+' like ''%'+LeftStr(WoNo, L-1)+'%''';
end;
if not dmcon.WoClampIn.IsEmpty then
begin
dmcon.WoClampIn.First;
if (dmcon.WoClampInPROD_STATUS.Value=5) or (dmcon.WoClampInPROD_STATUS.Value=6) then
begin
CheckBox4.Enabled:=True;
CheckBox4.Checked:=false;
end
else
begin
CheckBox4.Enabled:=True;
CheckBox4.Checked:=false;
end;
r_type:=1;
for i:=1 to dmcon.WoClampIn.RecordCount do
begin
item:=lv1.Items.Add;
Item.SubItems.Add(dmcon.WoClampInWORK_ORDER_NUMBER.Value);
Item.SubItems.Add(dmcon.WoClampInCUTNO_WO.Value);
Item.SubItems.Add(dmcon.WoClampInQTY_BACKLOG.AsString);
Item.SubItems.Add(dmcon.WoClampInPANELS.AsString);
Item.SubItems.Add(dmcon.WoClampInSTEP.AsString);
Item.SubItems.Add(dmcon.WoClampInrkey06.AsString);
dmcon.WoClampIn.Next;
end;
end;
</blockquote>
<p>
   end;<br />
  end<br />
  else<br />
  begin<br />
   with dmcon.WoClamp do //刻印内容不为空就得根据刻印内容那进行判断了<br />
   begin<br />
   Close;<br />
   Parameters[0].Value:=dmcon.adsWOInfo.FieldValues['cutno_wo'];<br />
</p>
<blockquote>
if (dmcon.adsWOInfo.FieldByName('Wtype06').Value=3)and(dmcon.adsWOInfo.FieldByName('wtype').AsInteger&gt;0) then //作业单为返工状态且返工还没结束
begin
with dmcon.tmp do
begin
Close;
sql.Clear;
SQL.Add('select max(step_number) as mstep from data0238 ');
sql.Add('where data0238.wo_ptr='+dmcon.adsWOInfo.FieldbyName('rKey06').AsString);
Open;
end;
if dmcon.NextStep_238.FieldByName('step_number').Value=dmcon.tmp.FieldByName('mstep').Value then //返工为最后一个工序时，步骤会发生变化
Parameters[1].Value:=dmcon.adsWOInfo.FieldValues['wtype']
else
Parameters[1].Value:=dmcon.NextStep_238.FieldValues['step_number'];
end
else
begin
Parameters[1].Value:=dmcon.aqNextStepNO.FieldValues['step_number'];
end;
Open;
</blockquote>
<p>
   end;<br />
   if not dmcon.WoClamp.IsEmpty then<br />
   begin<br />
</p>
<blockquote>
dmcon.WoClamp.First;
if (dmcon.WoClampPROD_STATUS.Value=5) or (dmcon.WoClampPROD_STATUS.Value=6) then
begin
CheckBox4.Enabled:=True;
CheckBox4.Checked:=false;
end
else
begin
CheckBox4.Enabled:=True;
CheckBox4.Checked:=False;//默认都不合卡由过数员自己选择控制
end;
r_type:=1;
for i:=1 to dmcon.WoClamp.RecordCount do
begin
item:=lv1.Items.Add;
Item.SubItems.Add(dmcon.WoClampWORK_ORDER_NUMBER.Value);
Item.SubItems.Add(dmcon.WoClampCUTNO_WO.Value);
Item.SubItems.Add(dmcon.WoClampQTY_BACKLOG.AsString);
Item.SubItems.Add(dmcon.WoClampPANELS.AsString);
Item.SubItems.Add(dmcon.WoClampSTEP.AsString);
Item.SubItems.Add(dmcon.WoClamprkey06.AsString);
dmcon.WoClamp.Next;
end;
</blockquote>
<p>
   end;<br />
  end;<br />
  lv1.Enabled:=CheckBox4.Checked;<br />
  ShowModal;<br />
end;<br />
</p>

<p>
procedure TfrmWO_Count.SpeedButton2Click(Sender: TObject);<br />
begin<br />
  close;<br />
end;<br />
</p>

<p>
procedure TfrmWO_Count.btnOkClick(Sender: TObject);<br />
var<br />
 sql_text:string;<br />
 rkey06:integer;<br />
 i:Integer;<br />
 lsresult:Boolean;<br />
 LErrStr,UrlAddress,Location,token,jsonstr,url: string;<br />
 str:TStringStream;<br />
 hp : TIdHTTP;<br />
</p>

<p>
begin<br />
</p>

<p>
  //<br />
  if dmcon.adsUserInfo.FieldByName('warehouse_ptr').AsInteger &gt; 0 then //过数权限设置了工厂<br />
  begin<br />
</p>
<blockquote>
if (ComboBox1.Text&lt;&gt;ComboBox2.Text) then
begin
ShowMessage('人员过数权限有限制工厂，过数工厂必须和生产工厂一致！');
ComboBox2.SetFocus;
exit;
end;
</blockquote>
<p>
  end;<br />
</p>

<p>
  //test;<br />
 // exit;<br />
</p>

<p>
  //*****************<br />
  //*生产过数管控，chengtx增加<br />
  LErrStr:=INQCLocked(dmcon.adsWOInfo.FieldbyName('rKey06').AsInteger,dmcon.adsWoInfo.fieldbyName('dept_ptr').AsInteger,dmcon.adsWoInfo.fieldbyName('QTY_BACKLOG').AsInteger);<br />
  if LErrStr&lt;&gt;'' then<br />
  begin<br />
</p>
<blockquote>
ShowMessage('该工单受到品质部门管控，原因如下：'+#13+LErrStr+'');
Exit;
</blockquote>
<p>
  end;<br />
  //*****************<br />
</p>


<p>
  //*****************<br />
  //*SPC管控，chengtx增加<br />
  if INSPCLocked(dmcon.adsWOInfo.FieldbyName('rKey06').AsInteger,dmcon.adsWoInfo.fieldbyName('dept_ptr').AsInteger,LErrStr) then<br />
  begin<br />
</p>
<blockquote>
ShowMessage(LErrStr + ' SPC检测信息受管控，请联系SPC 品质部！');
Exit;
</blockquote>
<p>
  end;<br />
  //*****************<br />
</p>

<p>
  //****<strong>相似交货尺寸提醒  ZSP增加</strong>**********<br />
  if CheckNearSize(dmcon.adsWOInfo.FieldbyName('BOM_PTR').AsInteger,NextDept) then Exit;<br />
  //*****************<br />
</p>

<p>
  //****<strong>客户型号相同工序有投诉处理，显示最新投诉内容提示  tang增加</strong>*********<br />
  LErrStr:=ShowComplaints(dmcon.adsWoInfo.fieldbyName('dept_ptr').AsInteger,Trim(dmcon.adsWoInfo.fieldbyName('MANU_PART_DESC').AsString));<br />
  if LErrStr&lt;&gt;'' then<br />
  begin<br />
</p>
<blockquote>
ShowMessage(LErrStr);
</blockquote>
<p>
  end;<br />
</p>

<p>
  //end*****************************<br />
  if IS_Stock_Inventorying then<br />
  begin<br />
   ShowMsg('在制品正在盘点，不能过数，请检查！',1);<br />
   Exit;<br />
  end;<br />
  rkey06:=dmcon.adsWOInfo.FieldbyName('rKey06').AsInteger;<br />
  lsresult:=True;<br />
  if (ComboBox3.Items.Count&gt;0) and (trim(ComboBox3.Text)='') then<br />
  begin<br />
</p>
<blockquote>
ShowMsg('请在收板前确定上工序的过数拉线或设备!',1);
ComboBox3.SetFocus;
exit;
</blockquote>
<p>
  end;<br />
  sql_text:='select step from data0056 where rkey='+dmcon.adsWOInfo.FieldByName('rkey').AsString;<br />
  OpenQuery(dmcon.aqTmp,sql_text);<br />
</p>

<p>
  if dmcon.aqTmp.FieldByName('step').AsInteger&lt;&gt;dmcon.adsWOInfo.FieldByName('step').AsInteger then<br />
  begin<br />
</p>
<blockquote>
ShowMsg('该在线作业单当前步骤已经不正确,可能有人已经过数!',1);
exit;
</blockquote>
<p>
  end;<br />
  with dmcon.ADOQuery1 do<br />
  begin<br />
</p>
<blockquote>
Close;
sql.Clear;
sql.Add('select * from data0238 where wo_ptr='+dmcon.adsWOInfo.FieldByName('rkey06').AsString);
Open;
</blockquote>
<p>
  end;<br />
  if dmcon.ADOQuery1.IsEmpty then<br />
  begin<br />
  sql_text:='select DEPT_PTR from data0038 where SOURCE_PTR='+dmcon.adsWOInfo.fieldByname('Bom_ptr').AsString+<br />
</p>
<blockquote>
'and STEP_NUMBER='+dmcon.adsWOInfo.fieldByname('STEP').AsString;
</blockquote>
<p>
  OpenQuery(dmcon.aqTmp,sql_text);<br />
   if dmcon.aqTmp.FieldByName('dept_ptr').Value&lt;&gt;dmcon.adsWOInfo.FieldByName('dept_ptr').Value then<br />
   begin<br />
</p>
<blockquote>
MessageDlg('当前工序步骤发生变化,产品流程有改动,不能过数!',mtInformation,[mbOK],1);
Exit;
</blockquote>
<p>
   end;<br />
  end;<br />
</p>

<p>
  sql_text:='select prod_status from data0006 where rkey='+dmcon.adsWOInfo.FieldbyName('rKey06').AsString;<br />
  OpenQuery(dmcon.aqTmp,sql_text);<br />
</p>

<p>
  if dmcon.aqTmp.FieldByName('prod_status').AsInteger in [102,103] then<br />
  begin<br />
</p>
<blockquote>
ShowMsg('该在线作业单已暂缓!',1);
exit;
</blockquote>
<p>
  end;<br />
</p>

<p>
  sql_text:='select wipmat_status from data0006 where rkey='+dmcon.adsWOInfo.FieldbyName('rKey06').AsString;<br />
  OpenQuery(dmcon.aqTmp,sql_text);<br />
</p>
  
<p>
  if dmcon.aqTmp.FieldByName('WIPMAT_STATUS').AsInteger=0 then<br />
  begin<br />
   ShowMsg('该在线作业单还没分配完,不能过数!',1);<br />
   exit;<br />
  end;<br />
  if (r_type=1) and (CheckBox4.Checked) then //有合卡需求要判断是否选择了一个工单进行合卡<br />
  begin<br />
   for i:=0 to lv1.Items.Count-1 do<br />
   begin<br />
</p>
<blockquote>
if lv1.Items[I].Checked = true then
begin
clamp06:=StrToInt(lv1.Selected.SubItems.Strings[5]);//获取合卡母单的rkey值
lsresult:=True;
Break;
end
else
begin
lsresult:=False;
end;
</blockquote>
<p>
   end;<br />
  end;<br />
  if lsresult=False then<br />
  begin<br />
</p>
<blockquote>
MessageDlg('请选择一个工单合卡！',mtInformation,[mbOK],1);
Exit;
</blockquote>
<p>
  end;<br />
//  if dmcon.aqBasicParam.FieldByName('ppc_control23').AsInteger = 1 then //计工作量<br />
//  if not dmcon.adsEmployee.IsEmpty then<br />
//  begin<br />
//    if v_Pcs=dmcon.adsWOInfo.FieldByName('QTY_BACKLOG').AsInteger then<br />
//      if not Msg_Dlg_Ask('数量没有分配,确定不分配吗!','提示',1) then  exit;<br />
//    if v_Pcs &lt;&gt; dmcon.adsWOInfo.FieldByName('QTY_BACKLOG').AsInteger then<br />
//      if v_PNL&gt;0 then<br />
//      begin<br />
//        ShowMsg('数量没有分配完,请确定!',1);<br />
//        exit;<br />
//      end;<br />
//  end;<br />
  try<br />
</p>
<blockquote>
if not dmcon.ADOConnection1.InTransaction then
dmcon.ADOConnection1.BeginTrans;
</blockquote>
<blockquote>
if edtNewPCS.Text=EdtPcs.Text then
rkey06:=dmcon.adsWOInfo.FieldbyName('rKey06').AsInteger
else
if savAlid then
begin  //拆分
dmcon.aspWO_Split.Parameters.ParamByName('@OrgRkey').Value :=dmcon.adsWOInfo.FieldbyName('rKey06').AsInteger;
dmcon.aspWO_Split.Parameters.ParamByName('@WONO').Value :=sNWkNo;
dmcon.aspWO_Split.Parameters.ParamByName('@PCS').Value :=strtoint(edtNewPCS.Text);
dmcon.aspWO_Split.Parameters.ParamByName('@PNL').Value :=strtoint('0'+edtNewPNL.Text);
dmcon.aspWO_Split.Parameters.ParamByName('@User_ptr').Value :=dmcon.adsUserInfo.fieldbyName('empl_ptr').Asinteger;
dmcon.aspWO_Split.Parameters.ParamByName('@Remark').Value :='过数拆分'+edtNewPCS.Text+'PCS';
dmcon.aspWO_Split.ExecProc;
if dmcon.aspWO_Split.Parameters.ParamByName('@RETURN_VALUE').Value=0 then
begin
dmcon.tmp.Close;
dmcon.tmp.SQL.Text:='select rkey from data0006 where work_order_number='''+sNWkNo+'''';
dmcon.tmp.Open;
rkey06:=dmcon.tmp.Fields[0].AsInteger;
end else begin
if dmcon.ADOConnection1.InTransaction then dmcon.ADOConnection1.RollbackTrans;
showmessage('作业单拆分不成功,过数失败...');
modalresult:=mrok;
exit;
end;
end
else
exit;
</blockquote>
<p>
   if Update_Data(rkey06) then  //过数<br />
</p>
<blockquote>
begin
//////增加合拼料号子料号自动过数功能 add by hcc 2019-01-22
with dmcon.ADOSpellRelation do
begin
Close;
Parameters[0].Value:=dmcon.adsWOInfo.fieldbyname('bom_ptr').Value;
Parameters[1].Value:=dmcon.adsWOInfo.fieldbyname('SUB_LEVELS').Value;
Parameters[2].Value:=dmcon.adsWOInfo.fieldbyname('Bom_CutNo').Value;
Open;
end;
if not dmcon.ADOSpellRelation.IsEmpty  then
begin
dmcon.ADOSpellRelation.First;
while not dmcon.ADOSpellRelation.Eof do
begin
MyDataClass.OpenDataSetByPara(dmcon.ADOSpellRelation.fieldbyname('work_order_number').Value,dmcon.adsWOInfo_Son); //打开子作业单
if dmcon.adsWOInfo_Son.IsEmpty then
begin
ShowMessage(dmcon.ADOSpellRelation.fieldbyname('work_order_number').AsString+'合拼料号子单已不在线或有异常,不能跟母卡一起过数,请检查!');
dmcon.ADOSpellRelation.Next;
Continue;
end;
with dmcon.ADOQuery1 do
begin
Close;
SQL.Clear;
SQL.Add('select * from data0238 where wo_ptr='+dmcon.adsWOInfo_Son.FieldByName('rkey06').AsString);
Open;
end;
if (not dmcon.ADOQuery1.IsEmpty) and (dmcon.adsWOInfo_Son.FieldByName('Wtype06').Value=3)and(dmcon.adsWOInfo_Son.FieldByName('wtype').AsInteger&gt;0) then //作业单为返工状态且返工还没结束
begin //走返工流程238
dmcon.NextStep_238_Son.Close;
dmcon.NextStep_238_Son.Parameters.ParamByName('F01').Value :=dmcon.adsWOInfo_Son.fieldByname('rkey06').Value;
dmcon.NextStep_238_Son.Parameters.ParamByName('F02').Value :=dmcon.adsWOInfo_Son.fieldByname('STEP').Value;
dmcon.NextStep_238_Son.Open;
end
else
begin //走正常流程38
with dmcon.ADOQuery1 do
begin
Close;
SQL.Clear;
sql.Add('select DEPT_PTR from data0038 where SOURCE_PTR='+dmcon.adsWOInfo_Son.fieldByname('Bom_ptr').AsString);
sql.Add('and STEP_NUMBER='+dmcon.adsWOInfo_Son.fieldByname('STEP').AsString);
Open;
end;
if dmcon.ADOQuery1.FieldByName('dept_ptr').Value&lt;&gt;dmcon.adsWOInfo_Son.FieldByName('DEPT_PTR').Value then
begin
MessageDlg('当前子工单工序步骤发生变化,产品流程有改动,不能自动过数!',mtInformation,[mbOK],1);
Exit;
end;
dmcon.aqNextStepNO_Son.Close;
dmcon.aqNextStepNO_Son.Parameters.ParamByName('F01').Value :=dmcon.adsWOInfo_Son.fieldByname('Bom_ptr').Value;
dmcon.aqNextStepNO_Son.Parameters.ParamByName('F02').Value :=dmcon.adsWOInfo_Son.fieldByname('STEP').Value;
dmcon.aqNextStepNO_Son.open;
end;
if ((not dmcon.aqNextStepNO.IsEmpty) and (dmcon.aqNextStepNO.FieldByName('rkey').Value=dmcon.aqNextStepNO_son.FieldByName('rkey').Value))or ((not dmcon.NextStep_238.IsEmpty) and (dmcon.NextStep_238.FieldByName('rkey').Value=dmcon.NextStep_238_son.FieldByName('rkey').Value)) then
begin
If not Update_Data_son(dmcon.ADOSpellRelation.fieldbyname('rkey').Value) then
begin
MessageDlg('当前子工单自动过数失败,请检查合拼料号工艺流程是否合理!',mtInformation,[mbOK],1);
Exit;
end;
end;
dmcon.ADOSpellRelation.Next;
end;
end;
////// end 合拼料号子料号自动过数
dmcon.ADOConnection1.CommitTrans ;
if (edtNewPCS.Text&lt;&gt;EdtPcs.Text) and not CheckBox3.Checked then showmessage('拆分过数成功,新产生的作业单号为：'+sNWkNo);
if  CheckBox3.Checked then
with  TForm_report.Create(nil) do
try
ADS25.Parameters[0].Value:=dmcon.adsWOInfo.fieldbyname('bom_ptr').AsInteger;
ADS25.Open;
ADS06.Parameters[0].Value:=rkey06;
ADS06.Open;
ppReport1.Print;
finally
free;
end;
end
</blockquote>
<p>
   else<br />
</p>
<blockquote>
dmcon.ADOConnection1.RollbackTrans;
</blockquote>
<p>
  except<br />
</p>
<blockquote>
on E: Exception do
begin
dmcon.ADOConnection1.RollbackTrans;
messagedlg(E.Message,mterror,[mbcancel],0);
end;
</blockquote>
<p>
  end;<br />
  //发送品质信息ERP提示<br />
  dmcon.adsWOInfo.Close;<br />
  dmcon.adsWOInfo.Open;<br />
  with dmcon.ADOQuery1 do<br />
  begin<br />
</p>
<blockquote>
Close;
sql.Clear;
sql.Add('select data0073.rkey from data0245 inner join data0005 on data0245.user_ptr=data0005.rkey');
sql.Add('inner join data0073 on data0073.employee_ptr=data0005.rkey');
sql.Add('where data0245.dept_ptr='+dmcon.adsWOInfo.fieldbyname('DEPT_PTR').AsString);
Open;
</blockquote>
<p>
  end;<br />
  dmcon.ADO101.Close;<br />
  dmcon.ADO101.Parameters[0].Value:=dmcon.adsWOInfo.fieldbyname('DEPT_PTR').Value;<br />
  dmcon.ADO101.Parameters[1].Value:=dmcon.adsWOInfo.fieldbyname('bom_ptr').Value;<br />
  dmcon.ADO101.Open;<br />
  if (not dmcon.ADOQuery1.IsEmpty) and (dmcon.ADO101names_value.Value&lt;&gt;'') then<br />
  begin<br />
</p>
<blockquote>
with dmcon.ADOQuery3 do
begin
Close;
sql.Clear;
SQL.Add('select data0073.rkey from data0073 inner join data0005');
sql.Add('on data0073.employee_ptr=data0005.rkey where data0005.rkey='+dmcon.adsUserInfo.fieldbyname('empl_ptr').AsString);
Open;
end;
dmcon.ADO014.Close;
dmcon.ADO014.Open;
dmcon.ADO014.Append;
dmcon.ADO014MESSAGE.Value:=dmcon.ADO101names_value.AsString;
dmcon.ADO014whosend.Value:=dmcon.ADOQuery3.fieldbyname('rkey').AsInteger;
dmcon.ADO014.Post;
dmcon.ADOQuery1.First;
while not dmcon.ADOQuery1.Eof  do
begin
dmcon.ADO314.Close;
dmcon.ADO314.Open;
dmcon.ADO314.Append;
dmcon.ADO314d14_ptr.Value:=dmcon.ADO014rkey.Value;
dmcon.ADO314emp_ptr.Value:=dmcon.ADOQuery1.fieldbyname('rkey').Value;
dmcon.ADO314.Post;
dmcon.ADOQuery1.MoveBy(1);
end;
</blockquote>
<p>
   with dmcon.ADOQuery1 do<br />
   begin<br />
</p>
<blockquote>
Close;
sql.Add('update data0101 set if_send=1 from data0101 inner join data0118 on data0118.SOURCE_PTR=data0101.rkey');
SQL.Add('where data0118.RESP_DEPT_PTR='+dmcon.adsWOInfo.fieldbyname('DEPT_PTR').AsString);
SQL.Add('and data0101.CUSTOMER_PART_PTR='+dmcon.adsWOInfo.fieldbyname('bom_ptr').AsString);
Open;
</blockquote>
<p>
   end;<br />
  end;<br />
  //作业单合卡<br />
  if (r_type=1) and (CheckBox4.Checked=true) then<br />
  begin<br />
   with dmcon.ADOQuery1 do<br />
   begin<br />
</p>
<blockquote>
Close;
SQL.Clear;
SQL.Add('select from_wo_ptr from data0006');
SQL.Add('where rkey='+inttostr(clamp06));
Open;
</blockquote>
<p>
   end;<br />
   with dmcon.ADOQuery2 do<br />
   begin<br />
</p>
<blockquote>
Close;
SQL.Clear;
sql.Add('select from_wo_ptr from data0006');
sql.Add('where rkey='+inttostr(rkey06));
Open;
</blockquote>
<p>
   end;<br />
   if (rkey06=dmcon.ADOQuery1.FieldByName('from_wo_ptr').Value) or (dmcon.ADOQuery2.IsEmpty) then<br />
   begin<br />
</p>
<blockquote>
with dmcon.ADOQuery2 do
begin
Close;
sql.Clear;
sql.Add('select * from data0056 where wo_ptr='+inttostr(clamp06));
Open;
end;
with dmcon.ADOQuery3 do
begin
Close;
sql.Clear;
SQL.Add('select * from data0006 where rkey='+inttostr(clamp06));
Open;
end;
if (dmcon.ADOQuery2.FieldByName('TO_BE_STOCKED').Value&gt;0) or (dmcon.ADOQuery3.FieldByName('QUAN_PROD').Value&gt;0) then
begin
MessageDlg('在线子工单有待入库数量还没审核或有部分已完工,不能合卡!',mtInformation,[mbOK],1);
Close;
Exit;
end;
if WoClamp(clamp06,rkey06) then
begin
with dmcon.ADOQuery1 do
begin
Close;
sql.Clear;
sql.Text:=' insert into data0117(Source_ptr,Source_Type,NOTEPAD_PTR,Empl_ptr,Tdate,Action,Remark) '+
' values ('+IntToStr(rkey06)+',2,0,'+dmcon.adsUserInfo.fieldbyName('empl_ptr').AsString+',getdate(),'+IntToStr(8)+','+QuotedStr('作业单'+dmcon.adsWOInfo.FieldValues['work_order_number']+'跟作业单'+lv1.Selected.SubItems.Strings[0]+'合并'+' '+'数量为：'+edtpcs.Text)+')';
ExecSQL;
end;
ShowMessage('合并作业单成功，合并后的作业单号为：'+dmcon.adsWOInfo.FieldValues['work_order_number']);
end;
</blockquote>
<p>
   end<br />
   else<br />
   begin<br />
</p>
<blockquote>
if WoClamp(rkey06,clamp06) then
begin
with dmcon.ADOQuery1 do
begin
Close;
sql.Clear;
sql.Text:=' insert into data0117(Source_ptr,Source_Type,NOTEPAD_PTR,Empl_ptr,Tdate,Action,Remark) '+
' values ('+IntToStr(clamp06)+',2,0,'+dmcon.adsUserInfo.fieldbyName('empl_ptr').AsString+',getdate(),'+IntToStr(8)+','+QuotedStr('作业单'+dmcon.adsWOInfo.FieldValues['work_order_number']+'跟作业单'+lv1.Selected.SubItems.Strings[0]+'合并'+' '+'数量为：'+edtpcs.Text)+')';
ExecSQL;
end;
ShowMessage('合并作业单成功，合并后的作业单号为：'+lv1.Selected.SubItems.Strings[0]);
end;
</blockquote>
<p>
   end;<br />
  end;<br />
</p>

<p>
  //调用质量系统接口<br />
  with dm.dmcon.tmp do<br />
  begin<br />
</p>
<blockquote>
Close;
sql.Text := 'SELECT interfacedomain,interfaceurl,token from interface where active = 1 and interfaceCode = ''QuantityConfirm''';
Open;
if not IsEmpty then
begin
UrlAddress := FieldByName('interfacedomain').AsString;
Location := FieldByName('interfaceurl').AsString;
token := FieldByName('token').AsString;
</blockquote>

<p>
//      jsonstr := '{"customerPartNum":"' + dmcon.adsWOInfoMANU_PART_DESC.asstring<br />
//          + '","partNum":"' + dmcon.adsWOInfoMANU_PART_NUMBER.asstring<br />
//          + '","lotNum":"' + dmcon.adsWOInfoWORK_ORDER_NUMBER.asstring<br />
//          + '","processCode":"' + dmcon.adsWOInfoDEPT_CODE.asstring<br />
//          + '","processName":"' + dmcon.adsWOInfoDEPT_NAME.asstring + '"}';<br />
</p>
<blockquote>
url := UrlAddress + Format(Location,[dmcon.adsWOInfoMANU_PART_DESC.asstring,dmcon.adsWOInfoMANU_PART_NUMBER.asstring,dmcon.adsWOInfoWORK_ORDER_NUMBER.asstring,dmcon.adsWOInfoDEPT_CODE.asstring,dmcon.adsWOInfoDEPT_NAME.asstring]);
str := TStringStream.Create(jsonstr);
hp := TIdHTTP.Create(nil);
try
hp.Request.ContentType := 'application/json;Charset=UTF-8';
</blockquote>
<p>
//        hp.Request.CustomHeaders.Values['App-Token'] := token;<br />
</p>
<blockquote>
try
</blockquote>
<p>
//          ShowMessage('1');<br />
</p>
<blockquote>
hp.Get(url,str);
</blockquote>

<p>
//          ShowMessage(url);<br />
</p>
<blockquote>
except  on ex:Exception do
begin
ShowMessage(ex.Message);
end;
end;
finally
hp.Free;
str.Free;
end;
end;
</blockquote>
<p>
  end;<br />
  modalresult:=mrok;<br />
end;<br />
</p>

<p>
function TfrmWO_Count.Update_Data(rkey06:integer): boolean;<br />
var<br />
  sqlstr,s:string;<br />
  WType,PutType:Integer;<br />
  FromDept,NextDept,rkey51,rkey54,jhzq:integer;<br />
  jv:Extended;<br />
  paigong:Boolean;<br />
begin<br />
  Result:=False;<br />
  jhzq:=dmcon.adsWOInfo.FieldByName('交货周期').Value;<br />
  if (dmcon.adsWOInfo.FieldByName('Wtype06').Value=3)and(dmcon.adsWOInfo.FieldByName('wtype').AsInteger&gt;0) then //返工过数<br />
  begin<br />
   with dmcon do<br />
   begin<br />
</p>
<blockquote>
if rgType.ItemIndex=0 then
wType:= 0
else
if rgType.ItemIndex=1 then
wType:= 2
else
wType:=3;
sqlstr:=' SELECT D34.rKey,D34.DEPT_CODE, D34.DEPT_NAME,D238.STEP_NUMBER'+
' FROM dbo.Data0238 D238 INNER JOIN dbo.Data0034 D34 ON D238.DEPT_PTR = D34.RKEY '+
' WHERE D238.wo_ptr='+adsWOInfo.fieldByname('rkey06').Asstring+' and D238.Step_Number&gt;'+adsWOInfo.fieldByname('STEP').Asstring+
' and D238.Step_Number &lt;= '+dmcon.NextStep_238.fieldByName('STEP_NUMBER').AsString+
' order by Step_Number asc ';
MyDataClass.OpenQuery(aqTmp,sqlstr);
fromDept:=adsWoInfo.fieldbyName('dept_ptr').AsInteger;
aqTmp.First;
while not aqTmp.Eof do
begin
NextDept:=aqTmp.fieldbyName('rKey').AsInteger;
sqlstr:=' select big_dept_ptr from data0034 where rkey in('+IntToStr(fromDept)+','+IntToStr(NextDept)+')'+
' group by big_dept_ptr ';
MydataClass.OpenQuery(aqTmp2,sqlstr);
if aqTmp2.RecordCount &gt;1 then //不同的班组
PutType:=1
else
PutType:=0;
result := Update_0048_2(fromDept,nextDept,dmcon.adsUserInfo.fieldbyName('empl_ptr').Asinteger,wType,PutType,rkey06,aqTmp.fieldbyName('Step_Number').AsInteger-1);
if not result then break;
fromDept:=aqTmp.fieldbyName('rKey').AsInteger;
aqTmp.Next;
end;
if not result then exit;
</blockquote>
<p>
//2.处理在线56表 DEPT_PTR：为下一步工序指针,STEP：为下一步步骤号,INTIME：为当前的过数时间,在线暂停小时数也清0<br />
</p>
<blockquote>
if CheckBox2.Checked then s:=',panels=0' else s:='';
sqlstr:=' update data0056 set dept_ptr='+NextStep_238.fieldByName('rKey').AsString+
' ,Step='+NextStep_238.fieldByName('STEP_NUMBER').AsString+s+
' ,loc_ptr='+inttostr(FaFct[ComboBox2.ItemIndex])+ //下一工序工厂
' ,if_paigong=0,assign_cycle=0,assign_date=null,datevalue=0,REFERENCE='+quotedstr(Trim(ComboBox4.Text))+ //初始化派工相关信息
' ,InTime=getdate(),if_message=0,flow_no=0 where Wo_ptr='+inttostr(rkey06);
</blockquote>
<blockquote>
sqlstr:= sqlstr +' update Data0056'
+' set Data0056.step=Data0056.wtype'  //返工过数到最后一步，完成返工过数，进入到正常流程过数
+' FROM Data0006 INNER JOIN'
+' Data0056 ON Data0006.RKEY = Data0056.WO_PTR '
+' WHERE ('+NextStep_238.fieldByName('STEP_NUMBER').AsString +' IN'
+' (SELECT MAX(step_number)'
+' FROM data0238 INNER JOIN'
+' data0034 ON data0238.dept_ptr = data0034.rkey'
+' WHERE data0238.wo_ptr = data0006.rkey AND'
+' data0034.barcode_entry_flag = ''Y'')) AND'
+' (Data0006.RKEY ='+ inttostr(rkey06)+')';
result := MyDataClass.ExecSql(sqlstr);
if not result then
begin
ShowMsg('更新56表失败!',1);
exit;
end;
//56增加派工相关信息
with ADOQuery1 do
begin
Close;
SQL.Clear;
sql.Add('select top 1 isnull(rkey,0) as rkey from data0051 where ' +inttostr(jhzq)+ '&gt;minvalue and '+inttostr(jhzq)+'&lt;=maxvalue');
Open;
end;
if ADOQuery1.IsEmpty then
rkey51:=0
else
rkey51:=dmcon.ADOQuery1.fieldbyname('rkey').Value;
if rkey51&gt;0 then
begin
with ADOQuery2 do
begin
Close;
SQL.Clear;
sql.Add('select top 1 isnull(rkey,0) as rkey ,isnull(dateValue,0) as datevalue from data0054 where dept_ptr='+NextStep_238.fieldByName('rKey').AsString);
SQL.Add('and d051_ptr='+inttostr(rkey51));
Open;
end;
if ADOQuery2.IsEmpty then
begin
rkey54:=0;
jv:=0;
end
else
begin
rkey54:=ADOQuery2.fieldbyname('rkey').Value;
jv:=ADOQuery2.fieldbyname('datevalue').Value;
end;
if rkey54&gt;0 then
begin
sqlstr:=' update data0056 set if_paigong=1'+
' ,assign_cycle='+inttostr(jhzq)+
' ,assign_date=getdate()'+
' ,datevalue='+FloatToStr(jv)+' where Wo_ptr='+inttostr(rkey06);
result := MyDataClass.ExecSql(sqlstr);
if not result then
begin
ShowMsg('更新56表派工信息失败!',1);
exit;
end;
end;
end;
//3.处理作业单状态
if CheckBox1.Checked then//下一步工序是外发，那么要把作业单状态改为外发状态
sqlstr:='update data0006 set prod_status=4 where rKey='+inttostr(rkey06)
else                     //下一步工序不是外发，那么要把作业单状态改为正常状态
sqlstr:='update data0006 set prod_status=3 where rKey='+inttostr(rkey06);
result := myDataClass.ExecSql(sqlstr);
if not result then
begin
ShowMsg('更新作业单状态失败!',1);
exit;
end;
with dmcon.tmp do
begin
Close;
sql.Clear;
SQL.Add('select max(step_number) as mstep from data0238 ');
sql.Add('where data0238.wo_ptr='+inttostr(rkey06));
Open;
end;
if NextStep_238.fieldByName('STEP_NUMBER').Value=dmcon.tmp.FieldByName('mstep').Value then//判断是否返工已经结束
begin
with dmcon.ADOQuery1 do
begin
Close;
sql.Clear;
SQL.Add('select max(step_number) as mstep from data0038 inner join');
SQL.Add('data0034 ON data0038.dept_ptr = data0034.rkey');
sql.Add('WHERE data0038.source_ptr ='+adsWOInfo.fieldByName('bom_ptr').AsString+'AND');
sql.Add('data0034.barcode_entry_flag = ''Y''');
Open;
end;
if dmcon.ADOQuery1.FieldByName('mstep').Value=adsWOInfo.FieldByName('wtype').Value then //判断是否从最后一步返工的
begin
if adsWoInfo.FieldByName('Parent_ptr').AsInteger &gt;0 then //内层产品
begin
with dmcon.ADOQuery2 do
begin
Close;
SQL.Clear;
sql.Text:='update data0006 set prod_status=6 where rkey='+inttostr(rkey06);
ExecSQL;
end;
end
else                                                     //外层产品
begin
with dmcon.ADOQuery3 do
begin
Close;
SQL.Clear;
sql.Text:='update data0006 set prod_status=5 where rkey='+IntToStr(rkey06);
ExecSQL;
end;
end;
end;
with dmcon.tmp do
begin
Close;
sql.Clear;
sql.Text:='delete from data0238 where wo_ptr='+inttostr(rkey06);
ExecSQL;
end;
with dmcon.tmp do
begin
Close;
SQL.Clear;
sql.Text:='update data0056 set wtype=0 where wo_ptr='+inttostr(rkey06);
ExecSQL;
end;
end;
//Update_WIPMAT_STATUS(rkey06);
</blockquote>
<p>
   end;<br />
  end<br />
  else<br />
  begin<br />
  if dmcon.aqNextStepNO.IsEmpty then exit;//未能找到下一级,说明是最后的工序<br />
//先处理48,后处理56<br />
//1.新增产品流转记录48,  判断当前过数工序和下一道工序之间是否存在不需要过数的工序，<br />
//如果有，那么每个工序都插入一条48的记录。<br />
//判断作业单投产状态,先判断配料单492,如果状态属于MRB返修,代表返工<br />
   with dmcon do<br />
   begin<br />
</p>
<blockquote>
if rgType.ItemIndex=0 then
wType:= 0
else
if rgType.ItemIndex=1 then
wType:= 2
else
wType:=3;
</blockquote>
<blockquote>
sqlstr:=' SELECT D34.rKey,D34.DEPT_CODE, D34.DEPT_NAME, D38.STEP_NUMBER '+
' FROM dbo.Data0038 D38 INNER JOIN dbo.Data0034 D34 ON D38.DEPT_PTR = D34.RKEY '+
' WHERE D38.Source_ptr='+adsWOInfo.fieldByname('Bom_ptr').Asstring+' and D38.Step_Number&gt;'+adsWOInfo.fieldByname('STEP').Asstring+
' and D38.Step_Number &lt;= '+aqNextStepNO.fieldByName('STEP_NUMBER').AsString+
' order by Step_Number asc ';
MyDataClass.OpenQuery(aqTmp,sqlstr);
fromDept:=adsWoInfo.fieldbyName('dept_ptr').AsInteger;
aqTmp.First;
while not aqTmp.Eof do
begin
NextDept:=aqTmp.fieldbyName('rKey').AsInteger;
sqlstr:=' select big_dept_ptr from data0034 where rkey in('+IntToStr(fromDept)+','+IntToStr(NextDept)+')'+
' group by big_dept_ptr ';
MydataClass.OpenQuery(aqTmp2,sqlstr);
if aqTmp2.RecordCount &gt;1 then //不同的班组
PutType:=1
else
PutType:=0;
result := Update_0048(fromDept,nextDept,dmcon.adsUserInfo.fieldbyName('empl_ptr').Asinteger,wType,PutType,rkey06,aqTmp.fieldbyName('Step_Number').AsInteger-1,dmcon.adsWOInfo.FieldByName('BOM_PTR').Value);
if not result then break;
fromDept:=aqTmp.fieldbyName('rKey').AsInteger;
aqTmp.Next;
end;
if not result then exit;
</blockquote>
<p>
//2.处理在线56表 DEPT_PTR：为下一步工序指针,STEP：为下一步步骤号,INTIME：为当前的过数时间<br />
</p>
<blockquote>
if CheckBox2.Checked then s:=',panels=0' else s:='';
sqlstr:=' update data0056 set dept_ptr='+aqNextStepNO.fieldByName('rKey').AsString+
' ,Step='+aqNextStepNO.fieldByName('STEP_NUMBER').AsString+s+
' ,loc_ptr='+inttostr(FaFct[ComboBox2.ItemIndex])+ //下工序工厂
' ,if_paigong=0,assign_cycle=0,assign_date=null,datevalue=0,REFERENCE='+quotedstr(Trim(ComboBox4.Text))+//初始化派工信息
' ,InTime=getdate() ,if_message=0,flow_no=0 where Wo_ptr='+inttostr(rkey06);
</blockquote>
<blockquote>
sqlstr:= sqlstr +' update Data0056'
+' set Data0056.WTYPE = 0'  //工序最后一步过数工序PACK,改为正常生产状态
+' FROM Data0006 INNER JOIN'
+' Data0056 ON Data0006.RKEY = Data0056.WO_PTR INNER JOIN'
+' Data0025 ON Data0006.BOM_PTR = Data0025.RKEY'
+' WHERE ('+aqNextStepNO.fieldByName('STEP_NUMBER').AsString +' IN'
+' (SELECT MAX(step_number)'
+' FROM data0038 INNER JOIN'
+' data0034 ON data0038.dept_ptr = data0034.rkey'
+' WHERE data0038.source_ptr = data0025.rkey AND'
+' data0034.barcode_entry_flag = ''Y'' AND'
+' data0038.flow_no = data0056.flow_no)) AND (Data0006.RKEY ='+ inttostr(rkey06)+')';
</blockquote>
<blockquote>
result := MyDataClass.ExecSql(sqlstr);
if not result then
begin
ShowMsg('更新56表失败!',1);
exit;
end;
//56增加派工相关信息
with ADOQuery1 do
begin
Close;
SQL.Clear;
sql.Add('select top 1 isnull(rkey,0) as rkey from data0051 where ' +inttostr(jhzq)+ '&gt;minvalue and '+inttostr(jhzq)+'&lt;=maxvalue');
Open;
end;
if ADOQuery1.IsEmpty then
rkey51:=0
else
rkey51:=dmcon.ADOQuery1.fieldbyname('rkey').Value;
if rkey51&gt;0 then
begin
with ADOQuery2 do
begin
Close;
SQL.Clear;
sql.Add('select top 1 isnull(rkey,0) as rkey,isnull(dateValue,0) as datevalue from data0054 where dept_ptr='+aqNextStepNO.fieldByName('rKey').AsString);
SQL.Add('and d051_ptr='+inttostr(rkey51));
Open;
end;
if ADOQuery2.IsEmpty then
begin
rkey54:=0;
jv:=0;
end
else
begin
rkey54:=ADOQuery2.fieldbyname('rkey').Value;
jv:=ADOQuery2.fieldbyname('datevalue').Value;
end;
if rkey54&gt;0 then
begin
sqlstr:=' update data0056 set if_paigong=1'+
' ,assign_cycle='+inttostr(jhzq)+
' ,assign_date=getdate()'+
' ,datevalue='+FloatToStr(jv)+' where Wo_ptr='+inttostr(rkey06);
result := MyDataClass.ExecSql(sqlstr);
if not result then
begin
ShowMsg('更新56表派工信息失败!',1);
exit;
end;
end;
end;
//3.处理作业单状态
if CheckBox1.Checked then//下一步工序是外发，那么要把作业单状态改为外发状态
sqlstr:='update data0006 set prod_status=4 where rKey='+inttostr(rkey06)
else                     //下一步工序不是外发，那么要把作业单状态改为正常状态
sqlstr:='update data0006 set prod_status=3 where rKey='+inttostr(rkey06);
result := myDataClass.ExecSql(sqlstr);
if not result then
begin
ShowMsg('更新作业单状态失败!',1);
exit;
end;
</blockquote>
<p>
   //4.处理作业单06表:当过数工序为最后一步工序时，如果是内层产品，就把作业单06状态更改为"待分配"（prod_status=6），如果是外层产品，作业单状态更改为"待入仓"（prod_status=5）<br />
//    sqlstr:=' SELECT 1 FROM dbo.Data0038 D38 INNER JOIN dbo.Data0034 D34 ON D38.DEPT_PTR = D34.RKEY '+<br />
//            ' WHERE D34.BARCODE_ENTRY_FLAG = '+QuotedStr('Y')+' and D38.Source_ptr='+adsWOInfo.fieldByname('Bom_ptr').Asstring+<br />
//            ' and D38.Step_Number&gt;'+ dmcon.aqNextStepNO.FieldByName('STEP_NUMBER').AsString;<br />
//    if not MyDataClass.IsExists(sqlstr) then//过数的下一道工序是最后一道工序了,那么要把作业单状态改变<br />
//    begin<br />
//      if adsWoInfo.FieldByName('Parent_ptr').AsInteger &gt;0 then //内层产品<br />
//        sqlstr:= ' Update data0006 set prod_status = 6 where rKey='+inttostr(rkey06)<br />
//      else                                                     //外层产品<br />
//        sqlstr:= ' Update data0006 set prod_status = 5 where rKey='+inttostr(rkey06);<br />
//      result := myDataClass.ExecSql(sqlstr);<br />
//      if not result then<br />
//      begin<br />
//        ShowMsg('更新作业单状态失败!',1);<br />
//        exit;<br />
//      end;<br />
//    end;<br />
</p>
<blockquote>
with dmcon.ADOQuery1 do
begin
Close;
SQL.Clear;
sql.Add('select bom_ptr from data0006 where rkey='+inttostr(rkey06));
Open;
end;
</blockquote>
<p>
//4.处理作业单06表:当过数工序为最后一步工序时，如果是内层产品，就把作业单06状态更改为"待分配"（prod_status=6），如果是外层产品，作业单状态更改为"待入仓"（prod_status=5）<br />
</p>
<blockquote>
sqlstr:=' SELECT 1 FROM dbo.Data0038 D38 INNER JOIN dbo.Data0034 D34 ON D38.DEPT_PTR = D34.RKEY '+
' WHERE D34.BARCODE_ENTRY_FLAG = '+QuotedStr('Y')+' and D38.Source_ptr='+dmcon.ADOQuery1.fieldByname('Bom_ptr').Asstring+
' and D38.Step_Number&gt;'+ dmcon.aqNextStepNO.FieldByName('STEP_NUMBER').AsString;
if not MyDataClass.IsExists(sqlstr) then//过数的下一道工序是最后一道工序了,那么要把作业单状态改变
begin
if adsWOInfoIsSpell.Value=true then //判断是不是合拼的产品(如果为true则为合拼料号)
begin
sqlstr:='update data0006 set prod_status=9 where rKey='+inttostr(rkey06);//更改作业单状态为生产结束
Result:=MyDataClass.ExecSql(sqlstr);
if not result then
begin
ShowMsg('更新合产品拼作业单状态失败!',1);
exit;
end;
sqlstr:='delete from data0056 where wo_ptr='+inttostr(rkey06);//删除在线作业单
Result:=MyDataClass.ExecSql(sqlstr);
if not result then
begin
ShowMsg('删除合拼产品在线作业单失败!',1);
exit;
end;
end
else
begin
if adsWoInfo.FieldByName('Parent_ptr').AsInteger &gt;0 then //内层产品
sqlstr:= ' Update data0006 set prod_status = 6 where rKey='+inttostr(rkey06)
else                                                     //外层产品
sqlstr:= ' Update data0006 set prod_status = 5 where rKey='+inttostr(rkey06);
result := myDataClass.ExecSql(sqlstr);
if not result then
begin
ShowMsg('更新作业单状态失败!',1);
exit;
end;
end;
end;
//Update_WIPMAT_STATUS(rkey06);
</blockquote>
<p>
   end;<br />
  end;<br />
end;<br />
</p>

<p>
function TfrmWO_Count.Update_0048(From_Dept,Next_Dept,UserId,WType,PutType,Wo_ptr,StepNo,rkey25:integer):boolean;<br />
var<br />
  sqlstr:string;<br />
  para_value:string;<br />
  flow_no:Integer;<br />
  jv:Extended; <br />
  paigong:Boolean;<br />
begin<br />
 paigong:=dmcon.adsWOInfo.FieldByName('if_paigong').Value;<br />
 jv:=dmcon.adsWOInfo.FieldByName('datevalue').Value;<br />
 dmcon.Para_Value.Close;<br />
 dmcon.Para_Value.Parameters[0].Value:=rkey25;<br />
 dmcon.Para_Value.Parameters[1].Value:=StepNo;<br />
 dmcon.Para_Value.Open;<br />
 para_value:=dmcon.Para_Valuenames_value.Value;<br />
 if Length(para_value)&gt;50 then<br />
 begin<br />
 para_value:='';<br />
 end;<br />
 with dmcon.tmp do<br />
 begin<br />
  close;<br />
  SQL.Clear;<br />
  SQL.Add('select Flow_No from data0056 where data0056.wo_ptr='+inttostr(Wo_ptr));<br />
  Open;<br />
 end;<br />
 flow_no:=dmcon.tmp.FieldValues['flow_no'];<br />
 sqlstr:=' insert into data0048(WO_PTR, FM_DEPT_PTR, TO_DEPT_PTR, INTIME, '+            //产量拉线<br />
</p>
<blockquote>
' OUTTIME, QTY_PROD, PANELS, STEP_NO, EMPL_PTR, WTYPE, put_type,warehouse_ptr,PARAMETER_VALUE,ACTION_REF,if_paigong,datevalue,flow_no) '+
' select Wo_ptr,'+IntToStr(From_Dept)+','+IntToStr(Next_Dept)+',case when assign_date is not null then assign_date ELSE INTIME end,getdate(),Qty_BackLog,Panels,'+IntToStr(StepNo)+','+IntToStr(UserId)+
' ,'+IntToStr(WType)+','+IntToStr(PutType)+','+inttostr(FaFct[ComboBox1.ItemIndex])+','''+para_value+''','''+ComboBox3.Text+''','+booltostr(paigong)+','+FloatToStr(jv)+','+inttostr(flow_no)+' from data0056 where Wo_ptr='+IntToStr(Wo_ptr);
</blockquote>
<p>
 result := MyDataClass.ExecSql(sqlstr);<br />
 if not result then<br />
 ShowMsg('更新48表出错!',1);<br />
end;<br />
</p>

<p>
function TfrmWO_Count.Update_0048_2(From_Dept,Next_Dept,UserId,WType,PutType,Wo_ptr,StepNo:integer):boolean;<br />
var<br />
  sqlstr:string;<br />
  flow_no:Integer;<br />
  jv:Extended;<br />
  paigong:Boolean;<br />
begin<br />
  paigong:=dmcon.adsWOInfo.FieldByName('if_paigong').Value;<br />
  jv:=dmcon.adsWOInfo.FieldByName('datevalue').Value;<br />
 with dmcon.ADOQuery1 do<br />
 begin<br />
   Close;<br />
   sql.Clear;<br />
   sql.Add('select old_step_no from data0238 where wo_ptr='+inttostr(Wo_ptr));<br />
   SQL.Add('and dept_ptr='+inttostr(From_Dept));<br />
   sql.Add('and step_number='+inttostr(StepNo));<br />
   Open;<br />
 end;<br />
 if (not dmcon.ADOQuery1.IsEmpty)then<br />
 begin<br />
   StepNo:=dmcon.ADOQuery1.FieldByName('old_step_no').Value;<br />
 end;<br />
 with dmcon.tmp do<br />
 begin<br />
  close;<br />
  SQL.Clear;<br />
  SQL.Add('select Flow_No from data0056 where data0056.wo_ptr='+inttostr(Wo_ptr));<br />
  Open;<br />
 end;<br />
 flow_no:=dmcon.tmp.FieldValues['flow_no'];<br />
 sqlstr:=' insert into data0048(WO_PTR, FM_DEPT_PTR, TO_DEPT_PTR, INTIME, '+            //产量拉线<br />
</p>
<blockquote>
' OUTTIME, QTY_PROD, PANELS, STEP_NO, EMPL_PTR, WTYPE, put_type,warehouse_ptr,ACTION_REF,if_paigong,datevalue,flow_no) '+
' select Wo_ptr,'+IntToStr(From_Dept)+','+IntToStr(Next_Dept)+',case when assign_date is not null then assign_date ELSE INTIME end,getdate(),Qty_BackLog,Panels,'+IntToStr(StepNo)+','+IntToStr(UserId)+
' ,'+IntToStr(WType)+','+IntToStr(PutType)+','+inttostr(FaFct[ComboBox1.ItemIndex])+','''+ComboBox3.Text+''','+booltostr(paigong)+','+FloatToStr(jv)+','+inttostr(flow_no)+' from data0056 where Wo_ptr='+IntToStr(Wo_ptr);
</blockquote>
<p>
 result := MyDataClass.ExecSql(sqlstr);<br />
 if not result then<br />
 ShowMsg('更新48表出错!',1);<br />
end;<br />
</p>

<p>
procedure TfrmWO_Count.SpeedButton4Click(Sender: TObject);<br />
begin<br />
  dmcon.adsEmployee.Filter := 'rKey34='+dmcon.adsWOInfo.fieldbyName('Dept_ptr').AsString;<br />
  dmcon.adsEmployee.filtered := true;<br />
end;<br />
</p>

<p>
procedure TfrmWO_Count.SpeedButton5Click(Sender: TObject);<br />
begin<br />
  dmcon.adsEmployee.Filter := '';<br />
  dmcon.adsEmployee.filtered := false;<br />
end;<br />
</p>

<p>
//function TfrmWO_Count.Update_0041(rkey06:integer): boolean;<br />
//var<br />
//  i,j:integer;<br />
//begin<br />
//  dmcon.ads0041.close;<br />
//  dmcon.ads0041.open;<br />
//  result := true;<br />
//  if sg1.RowCount &gt; 2 then<br />
//  begin<br />
//    for i:=1 to sg1.RowCount -2 do<br />
//    begin<br />
//      dmcon.ads0041.Append;<br />
//      dmcon.ads0041.FieldByName('source_ptr').AsInteger := rkey06;<br />
//      dmcon.ads0041.FieldByName('Dept_ptr').AsInteger := dmcon.adsWOInfo.FieldByName('Dept_ptr').AsInteger;<br />
//      dmcon.ads0041.FieldByName('empl_ptr').AsString := sg1.Cells[3,i];<br />
//      dmcon.ads0041.FieldByName('prod_pcs').AsString  := sg1.Cells[1,i];<br />
//      dmcon.ads0041.FieldByName('prod_pnls').AsString := sg1.Cells[2,i];<br />
//      dmcon.ads0041.Post;<br />
//    end;<br />
//  end;<br />
//  try<br />
//    dmcon.ads0041.UpdateBatch(arAll);<br />
//    result := true;<br />
//  except<br />
//    result := false;<br />
//  end;<br />
//end;<br />
</p>

<p>
procedure TfrmWO_Count.edtNewPCSKeyPress(Sender: TObject; var Key: Char);<br />
begin<br />
  if not (key in ['0'..'9',#8]) then abort;<br />
end;<br />
</p>

<p>
procedure TfrmWO_Count.edtNewPCSExit(Sender: TObject);<br />
var<br />
  PNLQty:integer;<br />
begin<br />
  if (trim(edtNewPCS.text)='') or (edtNewPNL.Enabled=false) then exit;<br />
  PNLQty:=Ceil(StrToInt(edtNewPCS.Text) / PCS_PER_PNL);<br />
  edtNewPNL.Text := IntToStr(PNLQty);<br />
end;<br />
</p>

<p>
procedure TfrmWO_Count.edtNewPNLExit(Sender: TObject);<br />
begin<br />
  if trim(edtNewPNL.text)='' then exit;<br />
  if StrToInt('0'+edtNewPcs.Text) &gt; 0 then exit;<br />
  edtNewPCS.Text := IntToStr(StrToInt(edtNewPNL.text) * PCS_PER_PNL);<br />
end;<br />
</p>

<p>
function TfrmWO_Count.savAlid: boolean;<br />
begin<br />
  result:=false;<br />
  if strtoint('0'+edtNewPCS.text)=0 then<br />
  begin<br />
</p>
<blockquote>
ShowMsg('拆分PCS数量不能为0,请注意',1);
edtNewPCS.SetFocus;
exit;
</blockquote>
<p>
  end;<br />
</p>

<p>
  if (edtPNL.Text&lt;&gt;'0') and (strtoint('0'+edtNewPNL.text)=0) then<br />
  begin<br />
</p>
<blockquote>
ShowMsg('拆分PNL不能为0,请注意',1);
edtNewPNL.SetFocus;
exit;
</blockquote>
<p>
  end;<br />
</p>

<p>
  if strtoint('0'+edtNewPNL.Text)&gt;strtoint('0'+edtNewPCS.Text) then<br />
  begin<br />
</p>
<blockquote>
showmessage('拆分PNL数不能超过拆分PCS数');
edtNewPCS.SetFocus;
exit;
</blockquote>
<p>
  end;<br />
</p>

<p>
  if StrToInt(edtNewPCS.text)&gt;StrToInt(edtPCS.Text)-StrToInt(edtDiscardQty.Text) then<br />
  begin<br />
</p>
<blockquote>
ShowMsg('拆分数量必须小于原作业单数量减去已申请报废数量,请注意',1);
edtNewPCS.SetFocus;
exit;
</blockquote>
<p>
  end;<br />
</p>

<p>
  if (edtNewPNL.text&lt;&gt;'') and (StrToInt(edtNewPNL.text)&gt;StrToIntdef(edtPNL.Text,0)) then<br />
  begin<br />
</p>
<blockquote>
ShowMsg('拆分PNL数必须小于原作业单PNL数,请注意',1);
edtNewPNL.SetFocus;
exit;
</blockquote>
<p>
  end;<br />
</p>

<p>
  Dmcon.tmp.Close;<br />
  Dmcon.tmp.SQL.Text:='SELECT a.QTY_BACKLOG,b.QUAN_ALLREJ, '+<br />
</p>
<blockquote>
'a.PANELS,b.QUAN_ALLpnl '+
'FROM dbo.Data0056 a inner join data0006 b '+
'on a.wo_ptr=b.rkey WHERE a.WO_PTR ='+dmcon.adsWOInfo.fieldbyName('rKey06').AsString;
</blockquote>

<p>
  Dmcon.tmp.Open;<br />
  if Dmcon.tmp.IsEmpty then<br />
  begin<br />
</p>
<blockquote>
ShowMsg('在线作业单已不存在...',1);
exit;
</blockquote>
<p>
  end;<br />
  if (edtPCS.Field.AsInteger&lt;&gt;Dmcon.tmp.Fields[0].AsInteger) or (edtDiscardQty.Field.AsInteger&lt;&gt;Dmcon.tmp.Fields[1].AsInteger) then<br />
  begin<br />
</p>
<blockquote>
ShowMsg('作业单在线状态发生变化,请先退出再过数...',1);
exit;
</blockquote>
<p>
  end;<br />
</p>

<p>
 { if Dmcon.tmp.Fields[0].AsInteger-Dmcon.tmp.Fields[1].AsInteger&lt;strtoint(edtNewPCS.Text) then<br />
  begin<br />
</p>
<blockquote>
showmessage('拆分PCS超过在线可拆分数量：'+inttostr(Dmcon.tmp.Fields[0].AsInteger-Dmcon.tmp.Fields[1].AsInteger)+',请修改!');
edtNewPCS.SetFocus;
exit;
</blockquote>
<p>
  end; }<br />
</p>

<p>
//  if CheckBox4.Checked then<br />
//  begin<br />
//    result:=true;<br />
//    exit;<br />
//  end;<br />
</p>

<p>
 { if Dmcon.tmp.Fields[2].AsInteger-Dmcon.tmp.Fields[3].AsInteger&lt;strtoint('0'+edtNewPNL.Text) then<br />
  begin<br />
</p>
<blockquote>
showmessage('拆分PNLS超过在线可拆分PNLS：'+inttostr(Dmcon.tmp.Fields[2].AsInteger-Dmcon.tmp.Fields[3].AsInteger)+',请修改!');
edtNewPCS.SetFocus;
exit;
</blockquote>
<p>
  end;<br />
   }<br />
  if (edtPNL.Text&lt;&gt;'0') and (Dmcon.tmp.Fields[0].AsInteger-Dmcon.tmp.Fields[1].AsInteger-strtoint(edtNewPCS.Text)&lt;Dmcon.tmp.Fields[2].AsInteger-Dmcon.tmp.Fields[3].AsInteger-strtoint('0'+edtNewPNL.Text)) then<br />
  begin<br />
</p>
<blockquote>
showmessage('拆分后在线PNLS超过在线PCS,请修改!');
edtNewPCS.SetFocus;
exit;
</blockquote>
<p>
  end;<br />
</p>

<p>
  if (edtPNL.Text&lt;&gt;'0') and ((Dmcon.tmp.Fields[0].AsInteger-Dmcon.tmp.Fields[1].AsInteger-strtoint(edtNewPCS.Text))/PCS_PER_PNL&gt;Dmcon.tmp.Fields[2].AsInteger-Dmcon.tmp.Fields[3].AsInteger-strtoint('0'+edtNewPNL.Text)) then<br />
  begin<br />
</p>
<blockquote>
showmessage('拆分后在线PNLS与在线PCS不符合逻辑,请修改!');
edtNewPCS.SetFocus;
exit;
</blockquote>
<p>
  end;<br />
  result:=false;<br />
end;<br />
</p>

<p>
procedure TfrmWO_Count.Update_WIPMAT_STATUS(rKey06: Integer);<br />
type<br />
  IntArr = array of Integer;<br />
</p>

<p>
  procedure SetWIPMAT_STATUSFalse(ARkey06: Integer);<br />
  var<br />
</p>
<blockquote>
LS: TStringList;
LQry: TADOQuery;
</blockquote>
<p>
  begin<br />
</p>
<blockquote>
LS := TStringList.Create;
LQry := TADOQuery.Create(Self);
try
LS.Add('UPDATE Data0006 SET WIPMAT_STATUS = 0 WHERE RKey = ');
LS.Add(IntToStr(ARkey06));
dmcon.SQLExec(LQry,LS);
finally
LS.Free;
LQry.Close;
LQry.Free;
end;
</blockquote>
<p>
  end;<br />
  function GetNowStep(ARkey06: Integer): Integer;<br />
  var<br />
</p>
<blockquote>
LS: TStringList;
LQry: TADOQuery;
</blockquote>
<p>
  begin<br />
</p>
<blockquote>
Result := -1;
LS := TStringList.Create;
LQry := TADOQuery.Create(Self);
try
LS.Add('SELECT STEP FROM Data0056 WHERE WO_PTR = ');
LS.Add(IntToStr(ARkey06));
if not dmcon.SQLOpen(LQry,LS) then Exit;
if LQry.IsEmpty then Exit;
Result := LQry.fieldByName('STEP').AsInteger;
finally
LS.Free;
LQry.Close;
LQry.Free;
end;
</blockquote>
<p>
  end;<br />
  procedure GetChildCombinStep(var Arr: IntArr; AParentRkey: Integer);<br />
  var<br />
</p>
<blockquote>
LS: TStringList;
LQry: TADOQuery;
I: Integer;
</blockquote>
<p>
  begin<br />
</p>
<blockquote>
LS := TStringList.Create;
LQry := TADOQuery.Create(Self);
try
LS.Add('SELECT D06.BOM_PTR ,D25.BOM_STEP FROM Data0006 D06 ');
LS.Add(' INNER JOIN Data0025 D25 ON D25.PARENT_PTR = D06.BOM_PTR ');
LS.Add(' WHERE D06.RKey = ');
LS.Add(IntToStr(AParentRkey));
if not dmcon.SQLOpen(LQry,LS) then Exit;
if LQry.IsEmpty then Exit;
SetLength(Arr,LQry.RecordCount);
LQry.First;
for I := 0 to LQry.RecordCount - 1 do
begin
Arr[I] := LQry.fieldByName('BOM_STEP').AsInteger;
LQry.Next;
end;  
finally
LS.Free;
LQry.Close;
LQry.Free;
end;
</blockquote>
<p>
  end;<br />
var<br />
  LChildStep: IntArr;<br />
  LParentNowStep: Integer;<br />
  I: Integer;<br />
begin<br />
  LParentNowStep := GetNowStep(rKey06);<br />
  if LParentNowStep = -1 then ShowMsg('06中没有找到记录',1);<br />
  GetChildCombinStep(LChildStep,rKey06);<br />
  for I := 0 to High(LChildStep) do<br />
  begin<br />
</p>
<blockquote>
if LParentNowStep = LChildStep[I] then
begin
SetWIPMAT_STATUSFalse(rKey06);
Exit;
end;
</blockquote>
<p>
  end;<br />
end;<br />
</p>

<p>
function TfrmWO_Count.WoClamp(rkey06,clamp06:Integer):Boolean;<br />
begin<br />
  Result:=False;<br />
 if check_woclamp(rkey06,clamp06) then<br />
 begin<br />
 dmcon.ADOConnection1.BeginTrans;<br />
 try<br />
  with dmcon.ADOQuery1 do //修改两张合并工单06表<br />
  begin<br />
   Close;<br />
   sql.Clear;<br />
   SQL.Add('select * from data0006 where rkey='+IntToStr(rkey06));<br />
   Open;<br />
  end;<br />
  with dmcon.ADOQuery2 do<br />
  begin<br />
   Close;<br />
   sql.Clear;<br />
   SQL.Add('select * from data0006 where rkey='+IntToStr(clamp06));<br />
   Open;<br />
  end;<br />
  dmcon.ADOQuery2.Edit;//合并母单数量增加<br />
  dmcon.ADOQuery2.FieldByName('quan_sch').Value:=dmcon.ADOQuery2.FieldByName('quan_sch').Value+dmcon.ADOQuery1.FieldByName('quan_sch').Value;<br />
  dmcon.ADOQuery2.FieldByName('quan_rej').Value:=dmcon.ADOQuery2.FieldByName('quan_rej').Value+dmcon.ADOQuery1.FieldByName('quan_rej').Value;<br />
  dmcon.ADOQuery2.FieldByName('QUAN_PROD').Value:=dmcon.ADOQuery2.FieldByName('quan_prod').Value+dmcon.ADOQuery1.FieldByName('quan_prod').Value;<br />
  dmcon.ADOQuery2.FieldByName('panels').Value:=dmcon.ADOQuery2.FieldByName('panels').Value+dmcon.ADOQuery1.FieldByName('panels').Value;<br />
  dmcon.ADOQuery2.Post;<br />
  dmcon.ADOQuery1.Edit;//子单数量清0<br />
  dmcon.ADOQuery1.FieldByName('prod_status').Value:=202;<br />
  dmcon.ADOQuery1.FieldByName('quan_sch').Value:=0;<br />
  dmcon.ADOQuery1.FieldByName('quan_rej').Value:=0;<br />
  dmcon.ADOQuery1.FieldByName('quan_prod').Value:=0;<br />
  dmcon.ADOQuery1.FieldByName('panels').Value:=0;<br />
  dmcon.ADOQuery1.Post;<br />
  with dmcon.ADOQuery1 do//修改报废记录工单指针<br />
  begin<br />
   Close;<br />
   sql.Clear;<br />
   sql.Add('update data0058 set wo_ptr='+IntToStr(clamp06)+' where wo_ptr='+IntToStr(rkey06));<br />
   ExecSQL;<br />
  end;<br />
  with dmcon.ADOQuery1 do//修改成品库存指针<br />
  begin<br />
   Close;<br />
   sql.Clear;<br />
   sql.Add('update data0053 set WORK_ORDER_PTR='+IntToStr(clamp06)+' where WORK_ORDER_PTR='+IntToStr(rkey06));<br />
   ExecSQL;<br />
  end;<br />
  with dmcon.ADOQuery1 do //修改母单56表在线数量（加上子单的数量）并删除子单在线作业单<br />
  begin<br />
   Close;<br />
   sql.Clear;<br />
   SQL.Add('select * from data0056 where wo_ptr='+IntToStr(rkey06));<br />
   Open;<br />
  end;<br />
 with dmcon.ADOQuery2 do<br />
 begin<br />
  Close;<br />
  sql.Clear;<br />
  SQL.Add('select * from data0056 where wo_ptr='+IntToStr(clamp06));<br />
  Open;<br />
 end;<br />
 dmcon.ADOQuery2.Edit; //母单在线作料单相关数量增加<br />
 dmcon.ADOQuery2.FieldByName('QTY_BACKLOG').Value:=dmcon.ADOQuery2.FieldByName('QTY_BACKLOG').Value+dmcon.ADOQuery1.FieldByName('QTY_BACKLOG').Value;<br />
 dmcon.ADOQuery2.FieldByName('TO_BE_STOCKED').Value:=dmcon.ADOQuery2.FieldByName('TO_BE_STOCKED').Value+dmcon.ADOQuery1.FieldByName('TO_BE_STOCKED').Value;<br />
 dmcon.ADOQuery2.FieldByName('panels').Value:=dmcon.ADOQuery2.FieldByName('panels').Value+dmcon.ADOQuery1.FieldByName('panels').Value;<br />
 dmcon.ADOQuery2.FieldByName('TO_BE_CANCD').Value:=dmcon.ADOQuery2.FieldByName('TO_BE_CANCD').Value+dmcon.ADOQuery1.FieldByName('TO_BE_CANCD').Value;<br />
 dmcon.ADOQuery2.Post;<br />
 with dmcon.ADOQuery3 do //子单在线工单删除<br />
 begin<br />
  Close;<br />
  sql.Clear;<br />
  SQL.Add('delete from data0056 where WO_PTR='+inttostr(rkey06));<br />
  ExecSQL;<br />
 end;<br />
   with dmcon.ADOQuery3 do   //更改过数记录48表子工单合并时的作业单指针（合并过数记录）<br />
   begin<br />
</p>
<blockquote>
Close;
sql.Clear;
sql.Add('update data0048 set wo_ptr='+inttostr(clamp06));
SQL.Add('where wo_ptr='+inttostr(rkey06));
ExecSQL;
</blockquote>
<p>
   end;<br />
  with dmcon.ADOQuery2 do //合并作业单分配0488表<br />
  begin<br />
</p>
<blockquote>
Close;
sql.Clear;
sql.Add('select * from data0488 where wo_ptr='+IntToStr(clamp06)+'order by rkey');
Open;
</blockquote>
<p>
  end;<br />
  with dmcon.ADOQuery1 do<br />
  begin<br />
</p>
<blockquote>
Close;
sql.Clear;
sql.Add('select * from data0488 where wo_ptr='+IntToStr(rkey06)+'order by rkey');
Open;
</blockquote>
<p>
  end;<br />
  if dmcon.ADOQuery2.IsEmpty=False then<br />
  begin<br />
</p>
<blockquote>
dmcon.ADOQuery2.First;
dmcon.ADOQuery1.First;
while not dmcon.ADOQuery2.Eof do
begin
dmcon.ADOQuery2.Edit;
dmcon.ADOQuery2.FieldByName('quan_req').Value:=dmcon.ADOQuery2.FieldByName('quan_req').Value+dmcon.ADOQuery1.FieldValues['quan_req'];
dmcon.ADOQuery2.FieldByName('quan_issued').Value:=dmcon.ADOQuery2.FieldByName('quan_issued').Value+dmcon.ADOQuery1.FieldValues['quan_issued'];
dmcon.ADOQuery2.Post;
dmcon.ADOQuery2.MoveBy(1);
dmcon.ADOQuery1.MoveBy(1);
end;
</blockquote>
<p>
  end;<br />
  with dmcon.ADOQuery3 do<br />
  begin<br />
</p>
<blockquote>
Close;
sql.Clear;
SQL.Add('delete from data0488 where wo_ptr='+IntToStr(rkey06));
ExecSQL;
</blockquote>
<p>
  end;<br />
  with dmcon.ADOQuery2 do //合并作业单分配0489表<br />
  begin<br />
</p>
<blockquote>
close;
SQL.Clear;
sql.Add('select * from data0489 where wo_ptr='+IntToStr(clamp06)+'order by TDATE');
Open;
</blockquote>
<p>
  end;<br />
  with dmcon.ADOQuery1 do<br />
  begin<br />
</p>
<blockquote>
close;
SQL.Clear;
sql.Add('select * from data0489 where wo_ptr='+IntToStr(rkey06)+'order by TDATE');
Open;
</blockquote>
<p>
  end;<br />
  if dmcon.ADOQuery2.IsEmpty=False then<br />
  begin<br />
</p>
<blockquote>
dmcon.ADOQuery2.First;
dmcon.ADOQuery1.First;
while not dmcon.ADOQuery2.Eof do
begin
dmcon.ADOQuery2.Edit;
dmcon.ADOQuery2.FieldByName('QTY').Value:=dmcon.ADOQuery2.FieldByName('QTY').Value+dmcon.ADOQuery1.FieldByName('QTY').Value;
dmcon.ADOQuery2.Post;
dmcon.ADOQuery2.MoveBy(1);
dmcon.ADOQuery1.MoveBy(1);
end;
</blockquote>
<p>
  end;<br />
  with dmcon.ADOQuery3 do<br />
  begin<br />
</p>
<blockquote>
Close;
SQL.Clear;
SQL.Add('delete from data0489 where wo_ptr='+inttostr(rkey06));
ExecSQL;
</blockquote>
<p>
  end;<br />
  //合并410表<br />
//  with dmcon.ADOQuery1 do<br />
//  begin<br />
//    Close;<br />
//    sql.Clear;<br />
//    sql.Add('select * from data0410 where wo_ptr='+inttostr(clamp06));<br />
//    Open;<br />
//  end;<br />
  with dmcon.ADOQuery2 do<br />
  begin<br />
</p>
<blockquote>
Close;
sql.Clear;
sql.Add('select * from data0410 where wo_ptr='+inttostr(rkey06));
Open;
</blockquote>
<p>
  end;<br />
  if not dmcon.ADOQuery2.IsEmpty then<br />
  begin<br />
</p>
<blockquote>
dmcon.ADOQuery2.First;
while not dmcon.ADOQuery2.Eof do
begin
with dmcon.ADOQuery1 do
begin
Close;
sql.Clear;
SQL.Add('select * from data0410 where wo_ptr='+inttostr(clamp06));
SQL.Add('and D0451_ptr='+dmcon.ADOQuery2.FieldByName('D0451_ptr').AsString);
SQL.Add('and step='+dmcon.ADOQuery2.FieldByName('step').AsString);
sql.Add('and dept_ptr='+dmcon.ADOQuery2.FieldByName('dept_ptr').AsString);
Open;
end;
if not dmcon.ADOQuery1.IsEmpty then
begin
dmcon.ADOQuery1.Edit;
dmcon.ADOQuery1.FieldByName('QTY').Value:=dmcon.ADOQuery1.FieldByName('QTY').Value+dmcon.ADOQuery2.FieldByName('QTY').Value;
dmcon.ADOQuery1.FieldByName('MATL_AMOUNT').Value:=dmcon.ADOQuery1.FieldByName('MATL_AMOUNT').Value+dmcon.ADOQuery2.FieldByName('MATL_AMOUNT').Value;
dmcon.ADOQuery1.FieldByName('ovhd1_AMOUNT').Value:=dmcon.ADOQuery1.FieldByName('ovhd1_AMOUNT').Value+dmcon.ADOQuery2.FieldByName('ovhd1_AMOUNT').Value;
dmcon.ADOQuery1.FieldByName('ovhd2_AMOUNT').Value:=dmcon.ADOQuery1.FieldByName('ovhd2_AMOUNT').Value+dmcon.ADOQuery2.FieldByName('ovhd2_AMOUNT').Value;
dmcon.ADOQuery1.FieldByName('ovhd3_AMOUNT').Value:=dmcon.ADOQuery1.FieldByName('ovhd3_AMOUNT').Value+dmcon.ADOQuery2.FieldByName('ovhd3_AMOUNT').Value;
dmcon.ADOQuery1.Post;
end
else
begin
dmcon.ADOQuery2.Edit;
dmcon.ADOQuery2.FieldByName('wo_ptr').Value:=clamp06;
dmcon.ADOQuery2.Post;
end;
dmcon.ADOQuery2.MoveBy(1);
end;
</blockquote>
<p>
  end;<br />
  with dmcon.ADOQuery3 do<br />
  begin<br />
</p>
<blockquote>
Close;
sql.Clear;
sql.Add('delete from data0410 where wo_ptr='+inttostr(rkey06));
ExecSQL;
</blockquote>
<p>
  end;<br />
  dmcon.ADOConnection1.CommitTrans;<br />
  Result:=True;<br />
 except<br />
  on E: Exception do<br />
  begin<br />
   Result:=False;<br />
   if dmcon.ADOConnection1.InTransaction then<br />
   dmcon.ADOConnection1.RollbackTrans;<br />
   ShowMessage('作业单在此工序合并失败,请检查！');<br />
  end;<br />
 end;<br />
 end;<br />
end;<br />
</p>

<p>
procedure TfrmWO_Count.lv1MouseDown(Sender: TObject; Button: TMouseButton;<br />
  Shift: TShiftState; X, Y: Integer);<br />
var<br />
  LItem: TListItem;<br />
  I: Integer;<br />
begin<br />
  LItem := lv1.GetItemAt(x,y);<br />
  if LItem = nil then Exit;<br />
  if LItem &lt;&gt; nil then<br />
  begin<br />
</p>
<blockquote>
for I := 0 to lv1.Items.Count - 1 do
begin
if lv1.Items[I] &lt;&gt; LItem then
lv1.Items[I].Checked := False;
end;
</blockquote>
<p>
  end;<br />
  LItem.Selected := True;<br />
end;<br />
</p>

<p>
procedure TfrmWO_Count.lv1SelectItem(Sender: TObject; Item: TListItem;<br />
  Selected: Boolean);<br />
var<br />
  LItem: TListItem;<br />
  I: Integer;<br />
begin<br />
  LItem := Item;<br />
  if LItem &lt;&gt; nil then<br />
  begin<br />
</p>
<blockquote>
for I := 0 to lv1.Items.Count - 1 do
begin
if lv1.Items[I] &lt;&gt; LItem then
lv1.Items[I].Checked := False;
end;
</blockquote>
<p>
  end;<br />
  LItem.Checked := not LItem.Checked;<br />
end;<br />
</p>

<p>
function TfrmWO_Count.check_woclamp(rkey06,clamp06:Integer):Boolean;//判断合并各个操作是否可正常进行<br />
begin<br />
  Result:=True;<br />
  with dmcon.ADOQuery1 do<br />
  begin<br />
</p>
<blockquote>
Close;
sql.Clear;
sql.Add('select * from data0006 where rkey='+IntToStr(rkey06));
Open;
</blockquote>
<p>
  end;<br />
  if (dmcon.ADOQuery1.FieldByName('wtype').Value=0) or  (dmcon.ADOQuery1.FieldByName('wtype').Value=1)  then<br />
  begin<br />
   Result:=True;<br />
  end<br />
  else<br />
  begin<br />
   MessageDlg('被合工单状态发生变化，不能合并！请检查！',mtInformation,[mbok],1);<br />
   Result:=False;<br />
   Exit;<br />
  end;<br />
</p>
<blockquote>
with dmcon.ADOQuery2 do //判断作业单分配0488表是否可以合并
</blockquote>
<p>
  begin<br />
</p>
<blockquote>
Close;
sql.Clear;
sql.Add('select * from data0488 where wo_ptr='+IntToStr(clamp06)+'order by rkey');
Open;
</blockquote>
<p>
  end;<br />
  with dmcon.ADOQuery1 do<br />
  begin<br />
</p>
<blockquote>
Close;
sql.Clear;
sql.Add('select * from data0488 where wo_ptr='+IntToStr(rkey06)+'order by rkey');
Open;
</blockquote>
<p>
  end;<br />
  if (dmcon.ADOQuery1.IsEmpty=False) and (dmcon.ADOQuery1.RecordCount&lt;&gt;dmcon.ADOQuery2.RecordCount) then<br />
  begin<br />
   MessageDlg('488记录存在差异，不能合并！请检查！',mtInformation,[mbok],1);<br />
   Result:=False;<br />
   Exit;<br />
  end;<br />
</p>
<blockquote>
with dmcon.ADOQuery2 do //判断0489表是否可以合并
</blockquote>
<p>
  begin<br />
</p>
<blockquote>
close;
SQL.Clear;
sql.Add('select * from data0489 where wo_ptr='+IntToStr(clamp06)+'order by TDATE');
Open;
</blockquote>
<p>
  end;<br />
  with dmcon.ADOQuery1 do<br />
  begin<br />
</p>
<blockquote>
close;
SQL.Clear;
sql.Add('select * from data0489 where wo_ptr='+IntToStr(rkey06)+'order by TDATE');
Open;
</blockquote>
<p>
  end;<br />
  if (dmcon.ADOQuery1.IsEmpty=False) and (dmcon.ADOQuery1.RecordCount&lt;&gt;dmcon.ADOQuery2.RecordCount) then<br />
  begin<br />
   MessageDlg('489记录存在差异，不能合并！请检查！',mtInformation,[mbok],1);<br />
   Result:=False;<br />
   Exit;<br />
  end;<br />
end;<br />
</p>

<p>
procedure TfrmWO_Count.lv1Exit(Sender: TObject);<br />
var i,rkey06:Integer;<br />
begin<br />
 rkey06:=dmcon.adsWOInfo.FieldbyName('rKey06').AsInteger;<br />
 for i:=0 to lv1.Items.Count-1 do<br />
 begin<br />
  if lv1.Items[I].Checked = true then<br />
  begin<br />
   clamp06:=StrToInt(lv1.Selected.SubItems.Strings[5]);//获取合卡母单的rkey值<br />
  end;<br />
 end;<br />
 with dmcon.ADOQuery1 do<br />
 begin<br />
  Close;<br />
  SQL.Clear;<br />
  SQL.Add('select from_wo_ptr from data0006');<br />
  SQL.Add('where rkey='+inttostr(clamp06));<br />
  Open;<br />
 end;<br />
 with dmcon.ADOQuery2 do<br />
 begin<br />
  Close;<br />
  SQL.Clear;<br />
  sql.Add('select from_wo_ptr from data0006');<br />
  sql.Add('where rkey='+inttostr(rkey06));<br />
  Open;<br />
 end;<br />
 if (rkey06=dmcon.ADOQuery1.FieldByName('from_wo_ptr').Value) or (dmcon.ADOQuery2.IsEmpty) then<br />
 begin<br />
  with dmcon.tmpQry do<br />
  begin<br />
</p>
<blockquote>
Close;
sql.Clear;
SQL.Add('select rkey from data0448 where wo_ptr='+inttostr(clamp06));
Open;
</blockquote>
<p>
  end;<br />
  if not dmcon.tmpQry.IsEmpty then<br />
  begin<br />
</p>
<blockquote>
lv1.Selected.Checked:=False;
</blockquote>
<p>
   ShowMessage('当前所选合卡工单在期末在制品截数内不能合卡,请选择其他工单!');<br />
  end;<br />
 end<br />
 else<br />
 begin<br />
 with dmcon.tmpQry do<br />
  begin<br />
</p>
<blockquote>
Close;
sql.Clear;
SQL.Add('select rkey from data0448 where wo_ptr='+inttostr(rkey06));
Open;
</blockquote>
<p>
  end;<br />
  if not dmcon.tmpQry.IsEmpty then<br />
  begin<br />
</p>
<blockquote>
lv1.Selected.Checked:=False;
</blockquote>
<p>
   ShowMessage('当前过数工单在期末在制品截数内不能合卡!');<br />
  end;<br />
 end;<br />
</p>

<p>
end;<br />
</p>

<p>
procedure TfrmWO_Count.CheckBox4Click(Sender: TObject);<br />
begin<br />
if CheckBox4.Checked=False then<br />
 begin<br />
  lv1.Selected.Checked:=False;<br />
  lv1.Enabled:=False;<br />
 end<br />
 else<br />
 begin<br />
  lv1.Enabled:=True;<br />
 end;<br />
end;<br />
</p>

<p>
function TfrmWO_Count.INQCLocked(ARkey06, ARkey34, AQty: Integer): string;<br />
var<br />
  LSql: string;<br />
begin<br />
  Result := '';<br />
</p>

<p>
  LSql := 'if object_id(N''dbo.QC_PassNumCheck'',N''U'') is not null begin select 1 end else select 0';<br />
  if not OpenQuery(dmcon.aqTmp,LSql) then Exit;<br />
  if dmcon.aqTmp.Fields[0].AsInteger = 0 then<br />
  begin<br />
</p>
<blockquote>
Exit;
</blockquote>
<p>
  end;<br />
</p>

<p>
  LSql := ' SELECT PassNum,InputRemark FROM qc_passNumCheck WHERE Enable = 1 AND Rkey06 = ' + IntToStr(ARkey06) +<br />
</p>
<blockquote>
' AND D34_ptr = ' + IntToStr(ARkey34);
</blockquote>
<p>
  if not OpenQuery(dmcon.aqTmp,LSql) then exit;<br />
  if not dmcon.aqTmp.IsEmpty then<br />
  begin<br />
</p>
<blockquote>
if AQty &gt; dmcon.aqTmp.FieldByName('PassNum').AsInteger then
begin
Result :=  dmcon.aqTmp.FieldByName('InputRemark').AsString;
end;
</blockquote>
<p>
  end;<br />
</p>

<p>
end;<br />
</p>

<p>
function TfrmWO_Count.INSPCLocked(ARkey06, ARkey34: Integer;var ErrStr: string): Boolean;<br />
var<br />
  LSql: string;<br />
  LQryDef,LQrySpcCheck: TADOQuery;<br />
  LCon: TADOConnection;<br />
  LWONumber: string;<br />
  LWHOUSE_PTR: string;<br />
begin<br />
  Result := False;<br />
//  LSql :=<br />
//  ' SELECT EDITED_BY FROM Data0006 d06 ' +<br />
//  ' inner join data0492 d492 on d492.CUT_NO = d06.CUT_NO ' +<br />
//  ' WHERE d492.WHOUSE_PTR = 1 and d06.rkey=' +  IntToStr(ARkey06);<br />
</p>
<blockquote>
LSql :=' SELECT EDITED_BY FROM Data0006 where rkey = ' +  IntToStr(ARkey06);
</blockquote>

<p>
  if not OpenQuery(dmcon.aqTmp,LSql) then Exit;<br />
  if dmcon.aqTmp.IsEmpty then Exit;<br />
  if dmcon.aqTmp.Fields[0].AsInteger = 1 then<br />
  begin<br />
</p>
<blockquote>
ShowMessage('此工单已经被品质锁定，请联系品质部解锁');
Result := True;
Exit;
</blockquote>
<p>
  end;<br />
</p>


<p>
  LSql := 'if object_id(N''dbo.SPC_LockDeptDef'',N''U'') is not null begin select 1 end else select 0';<br />
  if not OpenQuery(dmcon.aqTmp,LSql) then Exit;<br />
  if dmcon.aqTmp.Fields[0].AsInteger = 0 then<br />
  begin<br />
</p>
<blockquote>
Exit;
</blockquote>
<p>
  end;<br />
</p>


<p>
  LQryDef := TADOQuery.Create(Self);<br />
  LQrySpcCheck := TADOQuery.Create(Self);<br />
  LCon := TADOConnection.Create(Self);<br />
  LCon.LoginPrompt := False;<br />
  LQrySpcCheck.Connection := LCon;<br />
  try<br />
</p>
<blockquote>
LQryDef.Connection := dmcon.ADOConnection1;
dmcon.aqTmp.Close;
dmcon.aqTmp.SQL.Text := 'select WHOUSE_PTR from data0006 where rkey = ' + IntToStr(ARkey06);
dmcon.aqTmp.Open;
LWHOUSE_PTR := dmcon.aqTmp.fieldbyname('WHOUSE_PTR').AsString;
</blockquote>
<blockquote>
//取得spc定义的项目
LSql := 'SELECT * FROM SPC_LockDeptDef WHERE Active = 1 and D34_Ptr = ' + IntToStr(ARkey34) + ' and WHOUSE_PTR = ' + LWHOUSE_PTR;
LQryDef.SQL.Text := LSql;
LQryDef.Open;
</blockquote>
<blockquote>
if LQryDef.IsEmpty then
begin
Exit;
end;
</blockquote>
<blockquote>
dmcon.aqTmp.Close;
dmcon.aqTmp.SQL.Text := 'select work_order_number from data0006 where rkey = ' + IntToStr(ARkey06);
dmcon.aqTmp.Open;
LWONumber := dmcon.aqTmp.fieldbyname('work_order_number').AsString;
</blockquote>
<blockquote>
//取得spc的明细
LQryDef.First;
while not LQryDef.Eof do
begin
LSql := 'select 1 from ' + LQryDef.fieldbyname('SPCTableName').AsString + ' where ' + LQryDef.fieldbyname('WOCol').AsString + ' = ' + QuotedStr(LWONumber);
LCon.Close;
LCon.ConnectionString := LQryDef.FieldByName('ConStr').AsString;
LCon.Open;
LQrySpcCheck.Close;
LQrySpcCheck.SQL.Text := LSql;
LQrySpcCheck.Open;
if LQrySpcCheck.IsEmpty then
begin
Result := True;
ErrStr := LQryDef.fieldbyname('SPC_TestName').AsString;
Exit;
end;
LQryDef.Next;
end;
</blockquote>

<p>
  finally<br />
</p>
<blockquote>
LQryDef.Free;
LQrySpcCheck.Free;
LCon.Free;
</blockquote>
<p>
  end;<br />
</p>

<p>
end;<br />
</p>

<p>
function TfrmWO_Count.CheckNearSize(rkey25, nextdept_ptr: Integer): Boolean;<br />
var<br />
  qry:TADOQuery;<br />
  LLen,LWid:Double;<br />
  info:string;<br />
begin<br />
  Result:= False;<br />
  info:='当前工序有如下料号与接收料号交货尺寸相似：' + #13;<br />
  qry:=TADOQuery.Create(nil);<br />
  try<br />
</p>
<blockquote>
qry.Connection := dmcon.ADOConnection1;
with qry do
begin
Close;
SQL.Text:= 'select set_lngth,set_width from data0025 where rkey =' + IntToStr(rkey25);
</blockquote>
<p>
//      ShowMessage(SQL.text);<br />
</p>
<blockquote>
Open;
LLen:= FieldByName('set_lngth').Value;
LWid:= FieldByName('set_width').Value;
</blockquote>
<blockquote>
Close;
SQL.Text:= 'SELECT DISTINCT Data0025.MANU_PART_NUMBER,data0025.ORIG_CUSTOMER   '+#13+
' FROM  Data0025   '+#13+
'     inner join Data0006 on Data0006.BOM_PTR = Data0025.RKEY  '+#13+
'     inner join Data0056 on Data0056.WO_PTR = Data0006.RKEY   '+#13+
' WHERE (((set_lngth &gt;= '+ FloatToStr(LLen - 1)+') and (set_lngth &lt;= '+ FloatToStr(LLen + 1)+')  '+#13+
'     and (set_width &gt;= '+ FloatToStr(LWid - 1)+') and (set_width &lt;= '+ FloatToStr(LWid + 1)+'))  '+#13+
'     or     '+#13+
'     ((set_lngth &gt;= '+ FloatToStr(LWid - 1)+') and (set_lngth &lt;= '+ FloatToStr(LWid + 1)+')  '+#13+
'     and  (set_width &gt;= '+ FloatToStr(LLen - 1)+') and (set_width &lt;= '+ FloatToStr(LLen + 1)+')))   '+#13+
'     and (data0025.rkey &lt;&gt; '+ IntToStr(rkey25) +') '+#13+
'     and (Data0056.DEPT_PTR = ' + IntToStr(NextDept)+')';
Open;
if not IsEmpty then
begin
while not Eof do
begin
info:= info + FieldByName('MANU_PART_NUMBER').AsString + '、';
if (RecNo mod 3 = 0) then info:= info + #13;
next;
end;
info := info + #13 + '是否继续？';
</blockquote>
<p>
//        if FieldByName('ORIG_CUSTOMER').AsString = '深华为技术' then<br />
//        begin<br />
//          ShowMessage('工序存在相似板，且关联客户是华为技术，禁止过数。请联系计划部');<br />
//          Result := True;<br />
//          Exit;<br />
//        end else<br />
</p>
<blockquote>
begin
if MessageDlg(info, mtWarning, [mbYes,mbNo],0) &lt;&gt; mryes then Result := True;
end;
end;
end;
</blockquote>
<p>
  finally<br />
</p>
<blockquote>
qry.Free;
</blockquote>
<p>
  end;<br />
end;<br />
</p>

<p>
function TfrmWO_Count.ShowComplaints(Rkey34: Integer;<br />
  MANU_DESC: string): string;<br />
var i:Integer;<br />
</p>
<blockquote>
Adotmp:TADOQuery;
</blockquote>
<p>
begin<br />
  Result:='';<br />
  Adotmp:=TADOQuery.Create(Application);<br />
  try<br />
</p>
<blockquote>
Adotmp.Connection:=  dmcon.ADOConnection1;
Adotmp.Close;
Adotmp.SQL.Text:='select  ''该型号''+CONVERT(varchar(100),data0101.LOG_DATE,23)+''有投诉原因:''+data0101.[CONTENT] as RM '
+' from data0118 inner join '
+' data0101 on data0118.SOURCE_PTR=data0101.rkey inner join'
+' data0025 on data0101.CUSTOMER_PART_PTR=data0025.rkey inner join'
+' data0010 on data0101.CUSTOMER_PTR=data0010.rkey'
+' where data0101.STATUS&gt;0 and data0118.RESP_DEPT_PTR='+inttostr(Rkey34)+' and data0025.MANU_PART_DESC='''+MANU_DESC+''''
+' order by data0101.LOG_DATE desc';
Adotmp.Open;
if not Adotmp.IsEmpty then
Result:=Adotmp.fieldBYName('RM').AsString;
</blockquote>
<p>
  finally<br />
</p>
<blockquote>
Adotmp.Close;
Adotmp.Connection:=nil;
Adotmp.Free;
</blockquote>
<p>
  end;<br />
end;<br />
</p>

<p>
function TfrmWO_Count.Update_Data_Son(rkey06:integer): boolean;<br />
var<br />
  sqlstr,s:string;<br />
  WType,PutType:Integer;<br />
  FromDept,NextDept,rkey51,rkey54,jhzq:integer;<br />
  jv:Extended;<br />
  paigong:Boolean;<br />
begin<br />
  Result:=False;<br />
  jhzq:=dmcon.adsWOInfo_son.FieldByName('交货周期').Value;<br />
  if (dmcon.adsWOInfo_Son.FieldByName('Wtype06').Value=3)and(dmcon.adsWOInfo_Son.FieldByName('wtype').AsInteger&gt;0) then //返工过数<br />
  begin<br />
   with dmcon do<br />
   begin<br />
</p>
<blockquote>
if rgType.ItemIndex=0 then
wType:= 0
else
if rgType.ItemIndex=1 then
wType:= 2
else
wType:=3;
sqlstr:=' SELECT D34.rKey,D34.DEPT_CODE, D34.DEPT_NAME,D238.STEP_NUMBER'+
' FROM dbo.Data0238 D238 INNER JOIN dbo.Data0034 D34 ON D238.DEPT_PTR = D34.RKEY '+
' WHERE D238.wo_ptr='+adsWOInfo_son.fieldByname('rkey06').Asstring+' and D238.Step_Number&gt;'+adsWOInfo_son.fieldByname('STEP').Asstring+
' and D238.Step_Number &lt;= '+dmcon.NextStep_238_Son.fieldByName('STEP_NUMBER').AsString+
' order by Step_Number asc ';
MyDataClass.OpenQuery(aqTmp,sqlstr);
fromDept:=adsWOInfo_Son.fieldbyName('dept_ptr').AsInteger;
aqTmp.First;
while not aqTmp.Eof do
begin
NextDept:=aqTmp.fieldbyName('rKey').AsInteger;
sqlstr:=' select big_dept_ptr from data0034 where rkey in('+IntToStr(fromDept)+','+IntToStr(NextDept)+')'+
' group by big_dept_ptr ';
MydataClass.OpenQuery(aqTmp2,sqlstr);
if aqTmp2.RecordCount &gt;1 then //不同的班组
PutType:=1
else
PutType:=0;
result := Update_0048_2(fromDept,nextDept,dmcon.adsUserInfo.fieldbyName('empl_ptr').Asinteger,wType,PutType,rkey06,aqTmp.fieldbyName('Step_Number').AsInteger-1);
if not result then break;
fromDept:=aqTmp.fieldbyName('rKey').AsInteger;
aqTmp.Next;
end;
if not result then exit;
</blockquote>
<p>
//2.处理在线56表 DEPT_PTR：为下一步工序指针,STEP：为下一步步骤号,INTIME：为当前的过数时间,在线暂停小时数也清0<br />
</p>
<blockquote>
if CheckBox2.Checked then s:=',panels=0' else s:='';
sqlstr:=' update data0056 set dept_ptr='+NextStep_238_son.fieldByName('rKey').AsString+
' ,Step='+NextStep_238_son.fieldByName('STEP_NUMBER').AsString+s+
' ,loc_ptr='+inttostr(FaFct[ComboBox2.ItemIndex])+ //下一工序工厂
' ,if_paigong=0,assign_cycle=0,assign_date=null,datevalue=0'+ //初始化派工相关信息
' ,InTime=getdate(),if_message=0,flow_no=0 where Wo_ptr='+inttostr(rkey06);
</blockquote>
<blockquote>
sqlstr:= sqlstr +' update Data0056'
+' set Data0056.step=Data0056.wtype'  //返工过数到最后一步，完成返工过数，进入到正常流程过数
+' FROM Data0006 INNER JOIN'
+' Data0056 ON Data0006.RKEY = Data0056.WO_PTR '
+' WHERE ('+NextStep_238_son.fieldByName('STEP_NUMBER').AsString +' IN'
+' (SELECT MAX(step_number)'
+' FROM data0238 INNER JOIN'
+' data0034 ON data0238.dept_ptr = data0034.rkey'
+' WHERE data0238.wo_ptr = data0006.rkey AND'
+' data0034.barcode_entry_flag = ''Y'')) AND'
+' (Data0006.RKEY ='+ inttostr(rkey06)+')';
result := MyDataClass.ExecSql(sqlstr);
if not result then
begin
ShowMsg('更新56表失败!',1);
exit;
end;
//56增加派工相关信息
with ADOQuery1 do
begin
Close;
SQL.Clear;
sql.Add('select top 1 isnull(rkey,0) as rkey from data0051 where ' +inttostr(jhzq)+ '&gt;minvalue and '+inttostr(jhzq)+'&lt;=maxvalue');
Open;
end;
if ADOQuery1.IsEmpty then
rkey51:=0
else
rkey51:=dmcon.ADOQuery1.fieldbyname('rkey').Value;
if rkey51&gt;0 then
begin
with ADOQuery2 do
begin
Close;
SQL.Clear;
sql.Add('select top 1 isnull(rkey,0) as rkey ,isnull(dateValue,0) as datevalue from data0054 where dept_ptr='+NextStep_238_son.fieldByName('rKey').AsString);
SQL.Add('and d051_ptr='+inttostr(rkey51));
Open;
end;
if ADOQuery2.IsEmpty then
begin
rkey54:=0;
jv:=0;
end
else
begin
rkey54:=ADOQuery2.fieldbyname('rkey').Value;
jv:=ADOQuery2.fieldbyname('datevalue').Value;
end;
if rkey54&gt;0 then
begin
sqlstr:=' update data0056 set if_paigong=1'+
' ,assign_cycle='+inttostr(jhzq)+
' ,assign_date=getdate()'+
' ,datevalue='+FloatToStr(jv)+' where Wo_ptr='+inttostr(rkey06);
result := MyDataClass.ExecSql(sqlstr);
if not result then
begin
ShowMsg('更新56表派工信息失败!',1);
exit;
end;
end;
end;
//3.处理作业单状态
if CheckBox1.Checked then//下一步工序是外发，那么要把作业单状态改为外发状态
sqlstr:='update data0006 set prod_status=4 where rKey='+inttostr(rkey06)
else                     //下一步工序不是外发，那么要把作业单状态改为正常状态
sqlstr:='update data0006 set prod_status=3 where rKey='+inttostr(rkey06);
result := myDataClass.ExecSql(sqlstr);
if not result then
begin
ShowMsg('更新作业单状态失败!',1);
exit;
end;
with dmcon.tmp do
begin
Close;
sql.Clear;
SQL.Add('select max(step_number) as mstep from data0238 ');
sql.Add('where data0238.wo_ptr='+inttostr(rkey06));
Open;
end;
if NextStep_238_Son.fieldByName('STEP_NUMBER').Value=dmcon.tmp.FieldByName('mstep').Value then//判断是否返工已经结束
begin
with dmcon.ADOQuery1 do
begin
Close;
sql.Clear;
SQL.Add('select max(step_number) as mstep from data0038 inner join');
SQL.Add('data0034 ON data0038.dept_ptr = data0034.rkey');
sql.Add('WHERE data0038.source_ptr ='+adsWOInfo_son.fieldByName('bom_ptr').AsString+'AND');
sql.Add('data0034.barcode_entry_flag = ''Y''');
Open;
end;
if dmcon.ADOQuery1.FieldByName('mstep').Value=adsWOInfo_Son.FieldByName('wtype').Value then //判断是否从最后一步返工的
begin
if adsWOInfo_Son.FieldByName('Parent_ptr').AsInteger &gt;0 then //内层产品
begin
with dmcon.ADOQuery2 do
begin
Close;
SQL.Clear;
sql.Text:='update data0006 set prod_status=6 where rkey='+inttostr(rkey06);
ExecSQL;
end;
end
else                                                     //外层产品
begin
with dmcon.ADOQuery3 do
begin
Close;
SQL.Clear;
sql.Text:='update data0006 set prod_status=5 where rkey='+IntToStr(rkey06);
ExecSQL;
end;
end;
end;
with dmcon.tmp do
begin
Close;
sql.Clear;
sql.Text:='delete from data0238 where wo_ptr='+inttostr(rkey06);
ExecSQL;
end;
with dmcon.tmp do
begin
Close;
SQL.Clear;
sql.Text:='update data0056 set wtype=0 where wo_ptr='+inttostr(rkey06);
ExecSQL;
end;
end;
</blockquote>
<p>
   end;<br />
  end<br />
  else//正常过数<br />
  begin<br />
  if dmcon.aqNextStepNO_Son.IsEmpty then exit;//未能找到下一级,说明是最后的工序<br />
   with dmcon do<br />
   begin<br />
</p>
<blockquote>
if rgType.ItemIndex=0 then
wType:= 0
else
if rgType.ItemIndex=1 then
wType:= 2
else
wType:=3;
</blockquote>
<blockquote>
sqlstr:=' SELECT D34.rKey,D34.DEPT_CODE, D34.DEPT_NAME, D38.STEP_NUMBER '+
' FROM dbo.Data0038 D38 INNER JOIN dbo.Data0034 D34 ON D38.DEPT_PTR = D34.RKEY '+
' WHERE D38.Source_ptr='+adsWOInfo_son.fieldByname('Bom_ptr').Asstring+' and D38.Step_Number&gt;'+adsWOInfo_son.fieldByname('STEP').Asstring+
' and D38.Step_Number &lt;= '+aqNextStepNO_son.fieldByName('STEP_NUMBER').AsString+
' order by Step_Number asc ';
MyDataClass.OpenQuery(aqTmp,sqlstr);
fromDept:=adsWOInfo_Son.fieldbyName('dept_ptr').AsInteger;
aqTmp.First;
while not aqTmp.Eof do
begin
NextDept:=aqTmp.fieldbyName('rKey').AsInteger;
sqlstr:=' select big_dept_ptr from data0034 where rkey in('+IntToStr(fromDept)+','+IntToStr(NextDept)+')'+
' group by big_dept_ptr ';
MydataClass.OpenQuery(aqTmp2,sqlstr);
if aqTmp2.RecordCount &gt;1 then //不同的班组
PutType:=1
else
PutType:=0;
result := Update_0048(fromDept,nextDept,dmcon.adsUserInfo.fieldbyName('empl_ptr').Asinteger,wType,PutType,rkey06,aqTmp.fieldbyName('Step_Number').AsInteger-1,dmcon.adsWOInfo_Son.FieldByName('BOM_PTR').Value);
if not result then break;
fromDept:=aqTmp.fieldbyName('rKey').AsInteger;
aqTmp.Next;
end;
if not result then exit;
</blockquote>
<p>
//2.处理在线56表 DEPT_PTR：为下一步工序指针,STEP：为下一步步骤号,INTIME：为当前的过数时间<br />
</p>
<blockquote>
if CheckBox2.Checked then s:=',panels=0' else s:='';
sqlstr:=' update data0056 set dept_ptr='+aqNextStepNO_son.fieldByName('rKey').AsString+
' ,Step='+aqNextStepNO_son.fieldByName('STEP_NUMBER').AsString+s+
' ,loc_ptr='+inttostr(FaFct[ComboBox2.ItemIndex])+ //下工序工厂
' ,if_paigong=0,assign_cycle=0,assign_date=null,datevalue=0'+//初始化派工信息
' ,InTime=getdate() ,if_message=0,flow_no=0 where Wo_ptr='+inttostr(rkey06);
</blockquote>
<blockquote>
sqlstr:= sqlstr +' update Data0056'
+' set Data0056.WTYPE = 0'  //工序最后一步过数工序PACK,改为正常生产状态
+' FROM Data0006 INNER JOIN'
+' Data0056 ON Data0006.RKEY = Data0056.WO_PTR INNER JOIN'
+' Data0025 ON Data0006.BOM_PTR = Data0025.RKEY'
+' WHERE ('+aqNextStepNO_son.fieldByName('STEP_NUMBER').AsString +' IN'
+' (SELECT MAX(step_number)'
+' FROM data0038 INNER JOIN'
+' data0034 ON data0038.dept_ptr = data0034.rkey'
+' WHERE data0038.source_ptr = data0025.rkey AND'
+' data0034.barcode_entry_flag = ''Y'' AND'
+' data0038.flow_no = data0056.flow_no)) AND (Data0006.RKEY ='+ inttostr(rkey06)+')';
</blockquote>
<blockquote>
result := MyDataClass.ExecSql(sqlstr);
if not result then
begin
ShowMsg('更新56表失败!',1);
exit;
end;
//56增加派工相关信息
with ADOQuery1 do
begin
Close;
SQL.Clear;
sql.Add('select top 1 isnull(rkey,0) as rkey from data0051 where ' +inttostr(jhzq)+ '&gt;minvalue and '+inttostr(jhzq)+'&lt;=maxvalue');
Open;
end;
if ADOQuery1.IsEmpty then
rkey51:=0
else
rkey51:=dmcon.ADOQuery1.fieldbyname('rkey').Value;
if rkey51&gt;0 then
begin
with ADOQuery2 do
begin
Close;
SQL.Clear;
sql.Add('select top 1 isnull(rkey,0) as rkey,isnull(dateValue,0) as datevalue from data0054 where dept_ptr='+aqNextStepNO_son.fieldByName('rKey').AsString);
SQL.Add('and d051_ptr='+inttostr(rkey51));
Open;
end;
if ADOQuery2.IsEmpty then
begin
rkey54:=0;
jv:=0;
end
else
begin
rkey54:=ADOQuery2.fieldbyname('rkey').Value;
jv:=ADOQuery2.fieldbyname('datevalue').Value;
end;
if rkey54&gt;0 then
begin
sqlstr:=' update data0056 set if_paigong=1'+
' ,assign_cycle='+inttostr(jhzq)+
' ,assign_date=getdate()'+
' ,datevalue='+FloatToStr(jv)+' where Wo_ptr='+inttostr(rkey06);
result := MyDataClass.ExecSql(sqlstr);
if not result then
begin
ShowMsg('更新56表派工信息失败!',1);
exit;
end;
end;
end;
//3.处理作业单状态
if CheckBox1.Checked then//下一步工序是外发，那么要把作业单状态改为外发状态
sqlstr:='update data0006 set prod_status=4 where rKey='+inttostr(rkey06)
else                     //下一步工序不是外发，那么要把作业单状态改为正常状态
sqlstr:='update data0006 set prod_status=3 where rKey='+inttostr(rkey06);
result := myDataClass.ExecSql(sqlstr);
if not result then
begin
ShowMsg('更新作业单状态失败!',1);
exit;
end;
with dmcon.ADOQuery1 do
begin
Close;
SQL.Clear;
sql.Add('select bom_ptr from data0006 where rkey='+inttostr(rkey06));
Open;
end;
</blockquote>
<p>
   //4.处理作业单06表:当过数工序为最后一步工序时，如果是内层产品，就把作业单06状态更改为"待分配"（prod_status=6），如果是外层产品，作业单状态更改为"待入仓"（prod_status=5）<br />
</p>
<blockquote>
sqlstr:=' SELECT 1 FROM dbo.Data0038 D38 INNER JOIN dbo.Data0034 D34 ON D38.DEPT_PTR = D34.RKEY '+
' WHERE D34.BARCODE_ENTRY_FLAG = '+QuotedStr('Y')+' and D38.Source_ptr='+dmcon.ADOQuery1.fieldByname('Bom_ptr').Asstring+
' and D38.Step_Number&gt;'+ dmcon.aqNextStepNO_Son.FieldByName('STEP_NUMBER').AsString;
if not MyDataClass.IsExists(sqlstr) then//过数的下一道工序是最后一道工序了,那么要把作业单状态改变
begin
if adsWOInfo_Son.FieldByName('Parent_ptr').AsInteger &gt;0 then //内层产品
sqlstr:= ' Update data0006 set prod_status = 6 where rKey='+inttostr(rkey06)
else                                                     //外层产品
sqlstr:= ' Update data0006 set prod_status = 5 where rKey='+inttostr(rkey06);
result := myDataClass.ExecSql(sqlstr);
if not result then
begin
ShowMsg('更新作业单状态失败!',1);
exit;
end;
end;
</blockquote>
<p>
   end;<br />
  end;<br />
end;<br />
</p>

<p>
end.<br />
</p>


<div class="foot">
<button id="back_to_topA" class="back_to_top" style='background-color:red'>返回顶部</button>

<a id="returnIndexA" href="d:\vim\vim\mysite\note_html\笔记整理.html" onclick="fun_a()">
<button id=returnIndex class="back_to_index">返回首页</button>
</a>



<HR SIZE=5>
<p class="left">
<!-- <div class="text" style=" text-align:center;font-size:15px"></div>-->
© <span id="year">2018</span> 
</p>
<script src="scripts/my.js"></script>
<script src="scripts/script4Toc.js"></script>
<script type="text/javascript" src="scripts/codeStyleScript/XRegExp.js"></script>
<script type="text/javascript" src="scripts/codeStyleScript/shCore.js"></script>
<script type="text/javascript" src="scripts/codeStyleScript/shBrushJava.js"></script>
<script type="text/javascript" src="scripts/codeStyleScript/shBrushJScript.js"></script>
<script type="text/javascript" src="scripts/codeStyleScript/shBrushSql.js"></script>
<script type="text/javascript" src="scripts/codeStyleScript/shBrushCSharp.js"></script>
<script type="text/javascript" src="scripts/codeStyleScript/shBrushCss.js"></script>
<script type="text/javascript" src="scripts/codeStyleScript/shBrushPerl.js"></script>
<script type="text/javascript">
	SyntaxHighlighter.all()
</script>
</div>
</div>
</body>
</html>
