<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<link rel="Stylesheet" type="text/css" href="style.css">
<title>SQL</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script>
</head>
<body>

<h1>目录：</h1>
<div class="toc">
<ul>
<li><a href="#toc_1">软件 </a>
<li><a href="#toc_2">表 </a>
<ul>
<li><a href="#toc_2.1">自定义表类型 </a>
</ul>
<li><a href="#toc_3">数据库根据mdf还原 </a>
<li><a href="#toc_4">压缩日志备份数据库 </a>
<li><a href="#toc_5">SQL服务的启动</a>
<li><a href="#toc_6">SQL函数 </a>
<ul>
<li><a href="#toc_6.1">对查询出来的数据进行编号分页 </a>
<li><a href="#toc_6.2">for xml path </a>
<ul>
<li><a href="#toc_6.2.1">改变节点名称 </a>
<li><a href="#toc_6.2.2">改变节点 </a>
</ul>
</ul>
<li><a href="#toc_7">新建数据库服务器sa 无法登陆。 </a>
<li><a href="#toc_8">无法用ip登录 </a>
<li><a href="#toc_9">转移数据库 </a>
<li><a href="#toc_10">转移维护计划 </a>
<li><a href="#toc_11">更改系统密码后sql无法登录 </a>
<ul>
<li><a href="#toc_11.1">如何添加链接服务器</a>
</ul>
<li><a href="#toc_12">添加维护计划，执行T-SQL语句 </a>
<li><a href="#toc_13">如何备份数据库到网络盘 </a>
<li><a href="#toc_14">知道字段，查找表</a>
<li><a href="#toc_15">禁止在 .NET Framework 中执行用户代码。启用 "clr enabled" 配置选项。</a>
</ul>
</div>

<h1 id="toc_1">软件 </h1>
<p>
SSMS-Setup-CHS
</p>

<h1 id="toc_2">表 </h1>
<h2 id="toc_2.1">自定义表类型 </h2>
<p>
存储过程可以直接传递整个表过去。
数据库-&gt;可编程性-》类型-》用户定义表类型。
</p>

<h1 id="toc_3">数据库根据mdf还原 </h1>
<ol>
<li>
右击数据库，附加，选择mdf。选择还原。

<li>
如果报错。则先吧mdf和lf文件设置权限为everyone完全控制。

</ol>

<h1 id="toc_4">压缩日志备份数据库 </h1>
<p>
右击-》属性-》选项-》恢复模式改为简单
任务-》收缩-》文件-》文件类型选择日志-》确定
备份还原
右击-》属性-》选项-》恢复模式改为完整
</p>

<h1 id="toc_5">SQL服务的启动</h1>
<p>
所有程序-&gt;Microsoft SQL Server 2008 R2-&gt;配置工具-&gt;SQL Server 配置管理器
</p>
<h1 id="toc_6">SQL函数 </h1>

<h2 id="toc_6.1">对查询出来的数据进行编号分页 </h2>
<p>
 ROW_NUMBER() OVER ( ORDER BY ApplyTime)
</p>
 
<p>
SELECT  ROW_NUMBER() OVER ( ORDER BY ApplyTime) AS NUMBER,  *   FROM [EngSys].[dbo].[T_WF_FilmOrderDetialInfo]
</p>
  
<h2 id="toc_6.2">for xml path </h2>
<p>
把查询的结果已xml的形式输出  for xml path
</p>

<h3 id="toc_6.2.1">改变节点名称 </h3>
<p>
for xml path ('user')， path 后传入字符串参数
select jobName_ from [EngSys].[dbo].[T_WF_FilmOrderDetialInfo] t where jobName_ = 'bk100971b0'for xml path('')
</p>
<h3 id="toc_6.2.2">改变节点 </h3>
<p>
select ';'+jobName_ from [EngSys].[dbo].[T_WF_FilmOrderDetialInfo] t where jobName_ = 'bk100971b0'for xml path('')
</p>


<p>
UNION all
IsNull
</p>

<h1 id="toc_7">新建数据库服务器sa 无法登陆。 </h1>
<p>
1，服务器-》属性，安全性选择SQL Server 和windows身份验证模式；连接-》允许远程连接到此服务器。
2，安全性-&gt;登陆名-》sa-&gt;属性-常规-》把强制实施密码策略取消
3，放火墙-&gt;例外-》添加端口-&gt;名称sql-》端口号：1433
</p>

<h1 id="toc_8">无法用ip登录 </h1>
<p>
sql ServerConfiguration Manager(数据库服务管理)-&gt;把SqlServer网络配置的Tcp/ip的已禁用改为已启用。然后重启sqlserver。
</p>


<h1 id="toc_9">转移数据库 </h1>
<p>
1，如果是本机，可以直接备份数据库，把备份的数据库还原即可
2，在目的服务器建立同样名称的数据库，右击新建的数据库-》任务-》导入数据(只能导入表和视图)
3，存储过程需要右击源数据库，点击任务-》生成脚本-》把存储过程生成脚本，然后在目的数据库里面运行
</p>

<h1 id="toc_10">转移维护计划 </h1>
<ol>
<li>
连接服务器，服务器的类型选择Integration services

<li>
点击连接,展开--已存储的包--MSDB--Maintenance Plans

<li>
右键包--导出包

<li>
包位置选择File System(文件系统)

<li>
选择包路径。点确定。

<li>
点击连接,展开--已存储的包,右键Maintenance Plans导入包

<li>
然后对维护计划添加计划时间

</ol>
  
<h1 id="toc_11">更改系统密码后sql无法登录 </h1>
<p>
SqlServer服务-&gt;右击属性-选择登录-&gt;把密码修改
</p>


<h2 id="toc_11.1">如何添加链接服务器</h2>
<p>
点开服务器对象-&gt;点开链接服务器-&gt;右击新建链接服务器-&gt;
在常规里面填写
	1，填写链接服务器，也就是引用链接服务器时将使用的名称DGWZERP
	2，在服务器类型里面选择其他数据源
	3，在访问接口选择Microsoft OLE DB Provider for SQL Server
	4, 产品名称和链接服务器的名称相同
	5，数据源为源服务器的IP地址
</p>
	
<p>
在安全性里面填写
	1，本地登录(ems本地的账号登录，或者sa)，远程用户(链接服务器的用户)，远程密码
	2，使用此安全上下文建立连接，远程登录为远程用户，远程密码(不使用也可以)
</p>
<h1 id="toc_12">添加维护计划，执行T-SQL语句 </h1>
<p>
对象资源管理器(数据库服务器)-&gt;管理-&gt;维护计划-》右击，新建维护计划。填写名称-》填写作业计划属性。
生成子计划。查看-》工具箱-“执行 T-SQL 语句”任务
管理链接。编辑，使用特定的用户名和密码。
</p>


<h1 id="toc_13">如何备份数据库到网络盘 </h1>
<p>
use  Master
go
sp_configure 'show advanced options', 1;
go
reconfigure;
go
sp_configure 'xp_cmdshell', 1;
go
reconfigure;
go
</p>

<p>
--报错， 不支持对系统目录进行即席更新
sp_configure 'allow updates',0
</p>

<p>
-- To allow advanced options to be changed.  
EXEC sp_configure 'show advanced options', 1;  
GO  
</p>

<p>
-- To update the currently configured value for advanced options.  
RECONFIGURE;  
GO  
-- To enable the feature.  
EXEC sp_configure 'xp_cmdshell', 1;  
GO  
-- To update the currently configured value for this feature.  
RECONFIGURE;  
GO  
</p>

<p>
--接下来执行备份脚本进行测试：
</p>

<p>
DECLARE @backupfile VARCHAR(1024)
DECLARE @backdesc VARCHAR(1024)
DECLARE @filename VARCHAR(1024)
DECLARE @path VARCHAR(1024)
DECLARE @dbname VARCHAR(1024)
DECLARE @extension_name VARCHAR(16)
--定义游标
DECLARE tmp_Cur CURSOR
FOR
</p>
<blockquote>
SELECT  name
FROM    [sys].[databases]
WHERE   LOWER(name) IN ('zyCenter', 'TransDbCpu','AccessCtrl' )
</blockquote>
<p>
--开启映射
exec master..xp_cmdshell 'net use H: \\172.18.3.113\hc\DatabaseBak  "hcsystem" /user:D018002240\d018002240'
SET @path = N'H:\';
SET @extension_name = N'bak';
SET @filename = CONVERT(VARCHAR(1024), GETDATE(), 120)
SET @filename = REPLACE(@filename, ':', '')
SET @filename = REPLACE(@filename, '-', '')
SET @filename = REPLACE(@filename, ' ', '')
SET @filename = @filename + '_' + CONVERT (VARCHAR(3), DATEPART(ms, GETDATE()))
</p>
<blockquote>
+ N'.' + @extension_name
</blockquote>

<p>
--OPEN tmp_Cur;
--FETCH NEXT FROM tmp_Cur INTO @dbname;
--WHILE @@FETCH_STATUS = 0
</p>
<blockquote>
--BEGIN
SET @backupfile = @path + @dbname+'<em>full</em>'+ @filename
</blockquote>
<p>
  SET @backdesc =@dbname + N'-完整备份'
  print '---------------'
  print @backdesc
  print '---------------'
  -- 执行备份
</p>
<blockquote>
-- BACKUP DATABASE @dbname TO DISK = @backupfile WITH RETAINDAYS = 14,NOFORMAT, NOINIT,  NAME = @backdesc, SKIP, NOREWIND, NOUNLOAD,  STATS = 10, COMPRESSION
</blockquote>
<p>
backup database EngSys to disk=@backdesc with init
--FETCH NEXT FROM tmp_Cur INTO @dbname
  --  END
--CLOSE tmp_Cur;
--DEALLOCATE tmp_Cur;
</p>

<p>
-- 删除14天前的备份文件
DECLARE @olddate DATETIME
SELECT  @olddate = DATEADD(d, -14, GETDATE())
EXECUTE master.dbo.xp_delete_file 0, @path, @extension_name, @olddate, 1
--关闭映射
--exec master.sys.xp_cmdshell 'net use H: /delete'
</p>
 
<p>
sp_addumpdevice 'DISK','NetWork','\\172.18.3.113\hc\DatabaseBak\'
go
backup database EngSys to network
</p>

<p>
EXEC sp_configure 'show advanced options', 1;
RECONFIGURE;EXEC sp_configure 'xp_cmdshell', 1;
RECONFIGURE;
exec master..xp_cmdshell 'net use \\172.18.3.113\hc\DatabaseBak\ hcsystem /user:D018002240\d018002240'
backup database EngSys to disk='H:\testDB.bak' with init
</p>

<p>
<a href="志浩ERP查询.html">志浩ERP查询</a><br>
审核状态：0025:TSTATUS 
<a href="SQL存储过程.html">SQL存储过程</a><br>
<a href="ERP数据库.html">ERP数据库</a><br>
<a href="HX.html">HX</a><br>
<a href="数据库接入CLR程序集.html">数据库接入CLR程序集</a><br>
</p>

<p>
<a href="菲林还原.html">菲林还原</a><br>
</p>

<h1 id="toc_14">知道字段，查找表</h1>
<p>
select * from sysobjects  where id in (select id from syscolumns where name='RT_NUM')
select a.name as TableName,b.name as ColName From sysobjects a
inner join syscolumns b on (a.id=b.id)
where a.xtype='U' and b.name='字段'
</p>

<h1 id="toc_15">禁止在 .NET Framework 中执行用户代码。启用 "clr enabled" 配置选项。</h1>
<p>
exec sp_configure 'show advanced options', '0';
go
reconfigure  WITH OVERRIDE ;
go
exec sp_configure 'clr enabled', '1'
go
reconfigure  WITH OVERRIDE ;
exec sp_configure 'show advanced options', '1';
go
</p>

<button class="back_to_top" style='background-color:red'>返回顶部</button>

<a href="https://weipiaoyun.github.io/note_html/笔记整理.html">
<button class="back_to_index" style='background-color:red'>返回首页</button>
</a>

<script src="my.js"></script>
<HR SIZE=5>
<p class="left">
<!-- <div class="text" style=" text-align:center;font-size:15px"></div>-->
© <span id="year">2018</span> 
</p>
</body>
</body>
</html>
